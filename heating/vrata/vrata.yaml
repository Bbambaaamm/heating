# =====================================================================
# TEMPLATE (moderní syntaxe) – cover + template senzory
# =====================================================================
template:
  # -----------------------------
  # COVER: vrata_ui (migrace z platform: template)
  # -----------------------------
  - cover:
      - name: "Vrata"
        unique_id: vrata_ui
        device_class: gate

        # Stav – překlopí opening -> closed, closing -> open
        state: >
          {% set s = states('cover.vrata_gatebox_position') %}
          {% if s == 'opening' %}closed
          {% elif s == 'closing' %}open
          {% else %}{{ s }}
          {% endif %}

        # Pozice – potlačí „50 % při jízdě“
        position: >
          {% set s = states('cover.vrata_gatebox_position') %}
          {% if s == 'opening' %}0
          {% elif s == 'closing' %}100
          {% elif state_attr('cover.vrata_gatebox_position','current_position') is number %}
            {{ state_attr('cover.vrata_gatebox_position','current_position') | int }}
          {% else %}0
          {% endif %}

        # Všechna tři tlačítka posílají jeden pulz (toggle) na původní cover
        open_cover:
          - action: cover.open_cover
            target:
              entity_id: cover.vrata_gatebox_position
        close_cover:
          - action: cover.open_cover
            target:
              entity_id: cover.vrata_gatebox_position
        stop_cover:
          - action: cover.open_cover
            target:
              entity_id: cover.vrata_gatebox_position

  # -----------------------------
  # TEMPLATE SENSORY (ponecháno)
  # -----------------------------
  - binary_sensor:
      - name: "Opravený stav vrat"
        state: >
          {{ not is_state('cover.vrata_gatebox_position', 'closed') }}
        device_class: garage_door

  - trigger:
      - trigger: event
        event_type: bubble_card_update_modules
    sensor:
      - name: "Bubble Card Modules"
        state: "saved"
        icon: "mdi:puzzle"
        attributes:
          modules: "{{ trigger.event.data.modules }}"
          last_updated: "{{ trigger.event.data.last_updated }}"

# =====================================================================
# SCRIPT (může být i v scripts.yaml, tady je ponechán)
# =====================================================================
script:
  vrata_stop:
    alias: "Vrata – STOP"
    sequence:
      - action: cover.stop_cover
        target:
          entity_id: cover.vrata_ui
