# =====================================================================
# Soubor   : config/heating/analysis/heating_analytics.yaml
# Modul    : TopenÃ­ â€“ analytika kotle (cyklovÃ¡nÃ­, doba hoÅ™enÃ­, efektivita)
# ÃšÄel     : AnalÃ½za efektivity vytÃ¡pÄ›nÃ­ pro dashboard/Grafanu (starty, hoÅ™enÃ­, cykly)
# Autor    : Michal
# PoslednÃ­ Ãºprava : 2026-02-01
# PoznÃ¡mka : YAML syntaxe podle HA 2024.10 (template / history_stats)
# =====================================================================
# ðŸ“Œ Obsah:
#   - History Stats: starty za 1h / 24h, doba hoÅ™enÃ­ za 24h
#   - Template: prÅ¯mÄ›rnÃ¡ dÃ©lka cyklu, skÃ³re efektivity, duty cycle (%)
#
# ðŸ“ PoznÃ¡mky:
# - ZdrojovÃ½ signÃ¡l hoÅ™enÃ­: binary_sensor.boiler_burngas (stav "on" = hoÅ™Ã­)
# - VÅ¡echny template senzory vracÃ­ vÅ¾dy ÄÃ­slo a majÃ­ ochranu proti neplatnÃ½m stavÅ¯m
# - Atributy jsou pÅ™ipravenÃ© pro analÃ½zu v GrafanÄ› (period/source/calc/thresholds)
# =====================================================================

input_boolean:
  test_heating_analytics_loaded:
    name: "TEST â€“ Heating analytics loaded"
    icon: mdi:check-circle-outline

# ---------------------------------------------------------------------
# 1) ZÃ¡kladnÃ­ metriky z historie (history_stats)
# ---------------------------------------------------------------------
sensor:
  # Starty â€“ poslednÃ­ch 24h
  - platform: history_stats
    name: "kotel_start_count_24h"
    unique_id: kotel_start_count_24h
    entity_id: binary_sensor.boiler_burngas
    state: "on"
    type: count
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

  # Doba hoÅ™enÃ­ â€“ poslednÃ­ch 24h (hodiny)
  - platform: history_stats
    name: "kotel_burn_time_24h"
    unique_id: kotel_burn_time_24h
    entity_id: binary_sensor.boiler_burngas
    state: "on"
    type: time
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

  # Starty â€“ poslednÃ­ 1h
  - platform: history_stats
    name: "kotel_start_count_1h"
    unique_id: kotel_start_count_1h
    entity_id: binary_sensor.boiler_burngas
    state: "on"
    type: count
    start: "{{ now() - timedelta(hours=1) }}"
    end: "{{ now() }}"

# ---------------------------------------------------------------------
# 2) OdvozenÃ© metriky (template)
# ---------------------------------------------------------------------
template:
  - sensor:
      # Doba hoÅ™enÃ­ â€“ poslednÃ­ch 24h (minuty)
      - name: "kotel_burn_time_min_24h"
        unique_id: kotel_burn_time_min_24h
        unit_of_measurement: "min"
        state_class: measurement
        icon: mdi:fire-clock
        availability: >
          {{ states('sensor.kotel_burn_time_24h') not in ['unknown','unavailable','none',''] }}
        state: >
          {% set h = states('sensor.kotel_burn_time_24h') | float(0) %}
          {{ (h * 60) | round(1) }}
        attributes:
          period: "24h"
          source_entity: "binary_sensor.boiler_burngas"

      # PrÅ¯mÄ›rnÃ¡ dÃ©lka cyklu za 24h (minuty) = (doba hoÅ™enÃ­ v minutÃ¡ch / poÄet startÅ¯)
      - name: "kotel_avg_cycle_min_24h"
        unique_id: kotel_avg_cycle_min_24h
        unit_of_measurement: "min"
        state_class: measurement
        icon: mdi:chart-timeline-variant
        availability: >
          {{ states('sensor.kotel_start_count_24h') not in ['unknown','unavailable','none','']
             and states('sensor.kotel_burn_time_24h') not in ['unknown','unavailable','none',''] }}
        state: >
          {% set starts = states('sensor.kotel_start_count_24h') | float(0) %}
          {% set time_hours = states('sensor.kotel_burn_time_24h') | float(0) %}
          {% set time_min = time_hours * 60 %}
          {% if starts > 0 %}
            {{ (time_min / starts) | round(1) }}
          {% else %}
            0
          {% endif %}
        attributes:
          period: "24h"
          calc: "(burn_time_24h[h] * 60) / start_count_24h"

      # TOP metrika navÃ­c: Duty cycle (24h) â€“ podÃ­l Äasu hoÅ™enÃ­ v %
      - name: "kotel_burn_duty_cycle_24h"
        unique_id: kotel_burn_duty_cycle_24h
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:percent
        availability: >
          {{ states('sensor.kotel_burn_time_24h') not in ['unknown','unavailable','none',''] }}
        state: >
          {% set h = states('sensor.kotel_burn_time_24h') | float(0) %}
          {% set pct = (h / 24) * 100 %}
          {{ [pct, 100] | min | round(1) }}
        attributes:
          period: "24h"
          calc: "(burn_time_24h[h] / 24) * 100"

      # SkÃ³re efektivity (0â€“100 %) odvozenÃ© z prÅ¯mÄ›rnÃ© dÃ©lky cyklu (24h)
      - name: "kotel_efficiency_score"
        unique_id: kotel_efficiency_score
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:speedometer
        availability: >
          {{ states('sensor.kotel_avg_cycle_min_24h') not in ['unknown','unavailable','none',''] }}
        state: >
          {% set avg = states('sensor.kotel_avg_cycle_min_24h') | float(0) %}
          {% if avg >= 30 %}
            100
          {% elif avg <= 5 %}
            {{ (avg * 20) | round(0) }}
          {% else %}
            {{ (20 + (avg - 5) * 3.2) | round(0) }}
          {% endif %}
        attributes:
          period: "24h"
          source_entity: "binary_sensor.boiler_burngas"
          hodnoceni: >
            {% set s = states('sensor.kotel_efficiency_score') | int(0) %}
            {% if s > 80 %}ExcelentnÃ­ (dlouhÃ© cykly)
            {% elif s > 50 %}DobrÃ©
            {% elif s > 20 %}PrÅ¯mÄ›rnÃ© (ÄastÃ© starty)
            {% else %}KritickÃ© cyklovÃ¡nÃ­!
            {% endif %}

      # (stav = text â€œExcelentnÃ­ â€¦â€)
      # SkÃ³re efektivity (0â€“100 %) odvozenÃ© z prÅ¯mÄ›rnÃ© dÃ©lky cyklu (24h)
      - name: "Kotel â€“ hodnocenÃ­ efektivity"
        unique_id: kotel_efficiency_rating
        icon: mdi:label-outline
        state: >
          {{ state_attr('sensor.kotel_efficiency_score','hodnoceni') or '' }}
