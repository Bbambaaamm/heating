# =====================================================================
# Soubor   : config/heating/core/aggregate_kotel.yaml
# Modul    : Kotel – agregace poptávky zón
# =====================================================================

template:
  - sensor:
      # ---------------------------------------------------------------
      # SENSOR: Počet aktivních zón
      # ---------------------------------------------------------------
      - name: "kotel_aktivni_zony_pocet"
        unique_id: kotel_aktivni_zony_pocet
        unit_of_measurement: "zón"
        state: >
          {% set min_d = states('input_number.kotel_min_zone_demand_pct') | float(0) %}
          {% set count = namespace(value=0) %}

          {# Iterujeme přes všechny climate entity ve skupině #}
          {% for c in expand('group.topne_zony') %}
            {# Získáme čisté ID (např. 'sklep_michal' z 'climate.sklep_michal') #}
            {% set id = c.entity_id.split('.')[1] %}

            {# Dynamicky sestavíme názvy vašich senzorů #}
            {% set s_active = 'binary_sensor.zona_' ~ id ~ '_aktivni' %}
            {% set s_demand = 'sensor.zona_' ~ id ~ '_demand' %}

            {# Kontrola: Zóna aktivní AND Poptávka >= Min práh #}
            {% if is_state(s_active, 'on') and (states(s_demand) | float(0) >= min_d) %}
              {% set count.value = count.value + 1 %}
            {% endif %}
          {% endfor %}

          {{ count.value }}

      # ---------------------------------------------------------------
      # SENSOR: Průměrná poptávka aktivních zón (%)
      # ---------------------------------------------------------------
      - name: "kotel_poptavka_prumer"
        unique_id: kotel_poptavka_prumer
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set min_d = states('input_number.kotel_min_zone_demand_pct') | float(0) %}
          {% set ns = namespace(demands=[]) %}

          {% for c in expand('group.topne_zony') %}
            {% set id = c.entity_id.split('.')[1] %}
            {% set s_active = 'binary_sensor.zona_' ~ id ~ '_aktivni' %}
            {% set s_demand = 'sensor.zona_' ~ id ~ '_demand' %}
            {% set d_val = states(s_demand) | float(0) %}

            {% if is_state(s_active, 'on') and d_val >= min_d %}
              {% set ns.demands = ns.demands + [ d_val ] %}
            {% endif %}
          {% endfor %}

          {# Výpočet průměru (ošetření dělení nulou) #}
          {{ (ns.demands | average | round(1)) if (ns.demands | count) > 0 else 0 }}

      # ---------------------------------------------------------------
      # SENSOR: Maximální poptávka aktivních zón (%)
      # ---------------------------------------------------------------
      - name: "kotel_poptavka_max"
        unique_id: kotel_poptavka_max
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set min_d = states('input_number.kotel_min_zone_demand_pct') | float(0) %}
          {% set ns = namespace(demands=[]) %}

          {% for c in expand('group.topne_zony') %}
            {% set id = c.entity_id.split('.')[1] %}
            {% set s_active = 'binary_sensor.zona_' ~ id ~ '_aktivni' %}
            {% set s_demand = 'sensor.zona_' ~ id ~ '_demand' %}
            {% set d_val = states(s_demand) | float(0) %}

            {% if is_state(s_active, 'on') and d_val >= min_d %}
              {% set ns.demands = ns.demands + [ d_val ] %}
            {% endif %}
          {% endfor %}

          {{ (ns.demands | max) if (ns.demands | count) > 0 else 0 }}

  - binary_sensor:
      - name: "kotel_should_be_on"
        unique_id: kotel_should_be_on
        device_class: heat
        state: >-
          {{ is_state('binary_sensor.kotel_threshold_all_ok', 'on')
             and is_state('binary_sensor.kotel_mode_off_block', 'off') }}
        attributes:
          aktivni_zony: "{{ states('sensor.kotel_aktivni_zony_pocet') }}"
          prumerna_poptavka: "{{ states('sensor.kotel_poptavka_prumer') }}"
          boost_active: "{{ states('binary_sensor.kotel_boost_active') }}"

