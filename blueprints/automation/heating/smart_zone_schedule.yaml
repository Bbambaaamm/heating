blueprint:
  name: "Heating ‚Äì Smart zone schedule (with comfort capture)"
  description: >
    Chytr√Ω rozvrh pro jednu topnou z√≥nu.
    ≈ò√≠d√≠ komfort/ECO podle Scheduler booleanu a posledn√≠ komfortn√≠ teploty
    a z√°rove≈à ukl√°d√° posledn√≠ u≈æivatelsky nastaven√Ω komfortn√≠ setpoint.
    Podporuje glob√°ln√≠ re≈æimy: Auto / Eco / Boost / Off.
  domain: automation

  input:
    zone_name:
      name: N√°zev z√≥ny pro logbook
      description: Jak se m√° z√≥na jmenovat v logu (nap≈ô. 'P≈ô√≠zem√≠ Michal', '1P J√≠delna').
      selector:
        text:

    climate_entity:
      name: Climate entity z√≥ny
      selector:
        entity:
          domain: climate

    schedule_enable:
      name: Enable boolean pro rozvrh z√≥ny
      selector:
        entity:
          domain: input_boolean

    scheduler_entity:
      name: Scheduler Boolean (HACS)
      description: "Helper ovl√°dan√Ω Schedulerem (ON = komfortn√≠ okno, OFF = mimo okno)."
      selector:
        entity:
          domain: input_boolean

    last_comfort_helper:
      name: Helper ‚Äì posledn√≠ komfortn√≠ teplota (input_number)
      selector:
        entity:
          domain: input_number

    eco_temp_default:
      name: Eco teplota (input_number)
      selector:
        entity:
          domain: input_number

    boost_active:
      name: Boost aktivn√≠ (binary_sensor)
      description: "Binary sensor, kter√Ω ≈ô√≠k√°, ≈æe je aktivn√≠ Boost (nap≈ô. binary_sensor.kotel_boost_active)."
      selector:
        entity:
          domain: binary_sensor

    cooldown_seconds:
      name: Antispam ‚Äì cooldown (sekundy)
      description: "Minim√°ln√≠ ƒças mezi aplikacemi rozvrhu p≈ôi 'spam' triggerech (mimo scheduler trigger a mimo ruƒçn√≠ zmƒõnu setpointu)."
      default: 20
      selector:
        number:
          min: 0
          max: 300
          step: 1
          unit_of_measurement: s

    # -----------------------------------------------------------------
    # üß† MANU√ÅLN√ç OVERRIDE ‚Äì nov√© vstupy (priorita nad Schedulerem)
    # -----------------------------------------------------------------
    manual_override_boolean:
      name: Manu√°l ‚Äì override aktivn√≠ (input_boolean)
      description: "ON = manu√°ln√≠ override aktivn√≠ pro tuto z√≥nu (m√° prioritu nad rozvrhem)."
      selector:
        entity:
          domain: input_boolean

    manual_override_timer:
      name: Manu√°l ‚Äì timer override (timer)
      description: "Pokud bƒõ≈æ√≠ (active), override je ƒçasovƒõ aktivn√≠. P≈ôi idle/paused se ukonƒç√≠."
      selector:
        entity:
          domain: timer

    manual_override_type:
      name: Manu√°l ‚Äì typ ukonƒçen√≠ (input_select)
      description: "Volba: ƒåasovaƒç (podle timeru) / until_next_schedule (do dal≈°√≠ zmƒõny rozvrhu)."
      selector:
        entity:
          domain: input_select


mode: restart
initial_state: true

# ---------------------------------------------------------------
# TRIGGER
# ---------------------------------------------------------------
trigger:
  # Zmƒõna stavu Scheduler Booleanu (Komfort <-> Eco)
  - platform: state
    entity_id: !input scheduler_entity

  # Zmƒõna enable flagu nebo re≈æimu
  - platform: state
    entity_id:
      - !input schedule_enable
      - input_select.topny_rezim

  # Zmƒõna ‚Äûposledn√≠ komfortn√≠ teploty‚Äú ‚Üí reapply, pokud jsme v oknƒõ
  - platform: state
    entity_id: !input last_comfort_helper

  # Ruƒçn√≠ zmƒõna setpointu na hlavici ‚Üí zachy≈• komfort + p≈ô√≠padnƒõ reaguj
  - platform: state
    entity_id: !input climate_entity
    attribute: temperature

  # Zmƒõna ECO teploty
  - platform: state
    entity_id: !input eco_temp_default

  # -----------------------------------------------------------------
  # üß† MANU√ÅLN√ç OVERRIDE ‚Äì nov√© triggery
  # -----------------------------------------------------------------
  - platform: state
    entity_id: !input manual_override_boolean

  - platform: state
    entity_id: !input manual_override_timer

  - platform: state
    entity_id: !input manual_override_type

# ---------------------------------------------------------------
# CONDITIONS
# ---------------------------------------------------------------
condition:
  - condition: state
    entity_id: !input schedule_enable
    state: "on"

# ---------------------------------------------------------------
# VARIABLES
# ---------------------------------------------------------------
variables:
  zone_name: !input zone_name
  climate_entity: !input climate_entity
  scheduler_entity_id: !input scheduler_entity
  last_comfort_helper: !input last_comfort_helper
  eco_temp_entity: !input eco_temp_default
  boost_active_entity: !input boost_active
  cooldown_seconds: !input cooldown_seconds

  manual_override_boolean: !input manual_override_boolean
  manual_override_timer: !input manual_override_timer
  manual_override_type: !input manual_override_type

  mode: "{{ states('input_select.topny_rezim') }}"
  eco_temp: "{{ states(eco_temp_entity) | float(15) }}"
  last_comfort: "{{ states(last_comfort_helper) | float(22) }}"
  new_set: "{{ state_attr(climate_entity, 'temperature') | float(0) }}"

  # Co spustilo automatizaci
  is_scheduler_trigger: "{{ trigger.platform == 'state' and trigger.entity_id == scheduler_entity_id }}"
  is_climate_trigger: "{{ trigger.platform == 'state' and trigger.entity_id == climate_entity }}"

  # Antispam
  now_ts: "{{ as_timestamp(now()) }}"
  last_trig_ts: >
    {{ as_timestamp(state_attr(this.entity_id, 'last_triggered'))
       if state_attr(this.entity_id, 'last_triggered') else 0 }}
  since_last: "{{ (now_ts - last_trig_ts) | float(999999) }}"

  # === OKNO ===
  in_window: "{{ is_state(scheduler_entity_id, 'on') }}"

  # -----------------------------------------------------------------
  # üß† MANU√ÅLN√ç OVERRIDE ‚Äì stav
  # -----------------------------------------------------------------
  override_active: "{{ is_state(manual_override_boolean, 'on') }}"
  override_timer_active: "{{ is_state(manual_override_timer, 'active') }}"
  override_type: "{{ states(manual_override_type) }}"

  # -----------------------------------------------------------------
  # üß† Ruƒçn√≠ z√°sah u≈æivatele (UI / fyzick√° hlavice)
  # - user_id != null (zmƒõna z Dashboardu/Appky)
  # - parent_id == null (zmƒõna fyzicky na za≈ô√≠zen√≠, kter√° nem√° "rodiƒçe" v automatizaci)
  # - from_state != null (pojistka proti ‚Äûrestore/startup‚Äú ud√°lostem)
  # -----------------------------------------------------------------
  is_user_action: >
    {{ trigger is defined
      and trigger.to_state is defined
      and trigger.to_state.context is defined
      and (
        (trigger.to_state.context.user_id is not none)
        or (
          trigger.to_state.context.user_id is none
          and trigger.to_state.context.parent_id is none
          and trigger.from_state is not none
        )
      ) }}

  override_should_apply: >
    {{ override_active
       and (override_type == 'until_next_schedule'
            or (override_type == 'ƒåasovaƒç' and override_timer_active)) }}

# ---------------------------------------------------------------
# ACTION
# ---------------------------------------------------------------
action:
  # ===============================================================
  # 0) üß† MANU√ÅLN√ç OVERRIDE ‚Äì ukonƒçen√≠ ‚Äûdo dal≈°√≠ zmƒõny rozvrhu‚Äú
  # ===============================================================
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ override_active and override_type == 'until_next_schedule' and is_scheduler_trigger }}"
        sequence:
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ manual_override_boolean }}"
          - service: timer.cancel
            target:
              entity_id: "{{ manual_override_timer }}"
          - service: logbook.log
            data:
              name: "{{ zone_name }}"
              message: "Manu√°ln√≠ override ukonƒçen (dal≈°√≠ zmƒõna rozvrhu)."
              entity_id: "{{ climate_entity }}"

  # ===============================================================
  # 0b) üß† MANU√ÅLN√ç OVERRIDE ‚Äì priorita nad rozvrhem
  #     (ka≈æd√° hlavice se nastav√≠ na last_comfort)
  # ===============================================================
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ override_should_apply and mode in ['Auto','Boost','Eco'] }}"
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: "{{ climate_entity }}"
            data:
              hvac_mode: heat

          - condition: template
            value_template: >
              {{ ((state_attr(climate_entity, 'temperature') | float)
                  - (last_comfort | float)) | abs > 0.1 }}

          - service: climate.set_temperature
            target:
              entity_id: "{{ climate_entity }}"
            data:
              temperature: "{{ last_comfort }}"

          - service: logbook.log
            data:
              name: "{{ zone_name }}"
              message: "MANUAL override ‚Äì nastaven last comfort {{ last_comfort }} ¬∞C"
              entity_id: "{{ climate_entity }}"

          - stop: "MANUAL override m√° prioritu ‚Äì rozvrh se neaplikuje"

  # ---------------------------------------------------------------
  # 1) ZACHYCEN√ç KOMFORTN√ç TEPLOTY P≈òI RUƒåN√ç ZMƒöNƒö SETPOINTU
  # ---------------------------------------------------------------
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ is_climate_trigger }}"
          - condition: template
            value_template: "{{ new_set >= (eco_temp + 0.2) }}"
          - condition: template
            value_template: "{{ (last_comfort - new_set) | abs > 0.1 }}"
          - condition: template
            value_template: "{{ states(boost_active_entity) == 'off' }}"
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input last_comfort_helper
            data:
              value: "{{ new_set }}"

          - service: logbook.log
            data:
              name: "{{ zone_name }}"
              message: "Ulo≈æena komfortn√≠ teplota: {{ new_set }} ¬∞C"
              entity_id: "{{ climate_entity }}"

  # 1b) Ruƒçn√≠ zmƒõna v oknƒõ: ulo≈æeno, hned nep≈ôepisuj zpƒõt
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ is_climate_trigger
                 and mode in ['Auto','Boost']
                 and in_window
                 and new_set >= (eco_temp + 0.2) }}
        sequence:
          - stop: "Ruƒçn√≠ komfort v oknƒõ: ulo≈æeno, rozvrh teƒè nep≈ôepisuje"

  # ===============================================================
  # 1c) üß† Voliteln√© chov√°n√≠: Ruƒçn√≠ zmƒõna mimo okno ‚Üí aktivuj override
  #     (pokud chce≈°, aby otoƒçen√≠ hlavice mimo okno ‚Äûzapnulo manu√°l‚Äú)
  # ===============================================================
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ is_climate_trigger
                 and is_user_action
                 and mode in ['Auto','Boost']
                 and (not in_window)
                 and (not override_active)
                 and new_set >= (eco_temp + 0.2) }}
        sequence:
          - service: input_select.select_option
            target:
              entity_id: "{{ manual_override_type }}"
            data:
              option: "until_next_schedule"

          - service: timer.cancel
            target:
              entity_id: "{{ manual_override_timer }}"

          - service: input_boolean.turn_on
            target:
              entity_id: "{{ manual_override_boolean }}"

          # timed = ƒçek√°me, ≈æe timer si spust√≠≈° z UI (nebo dopln√≠me pozdƒõji)
          # until_next_schedule = timer se ignoruje
          - service: logbook.log
            data:
              name: "{{ zone_name }}"
              message: "Ruƒçn√≠ z√°sah mimo okno ‚Äì aktivov√°n manu√°ln√≠ override (until_next_schedule)."
              entity_id: "{{ climate_entity }}"

          - stop: "Ruƒçn√≠ z√°sah mimo okno ‚Äì p≈ôepnuto do manu√°ln√≠ho override"

  # ---------------------------------------------------------------
  # 0) ANTISPAM ‚Äì aplikaci rozvrhu throttle (NEPLAT√ç pro scheduler trigger a neplat√≠ pro ruƒçn√≠ otoƒçen√≠)
  # ---------------------------------------------------------------
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ (cooldown_seconds | int(0)) > 0
                 and not is_scheduler_trigger
                 and not is_climate_trigger
                 and (since_last | float(999999)) < (cooldown_seconds | int(0)) }}
        sequence:
          - stop: "Antispam: cooldown aktivn√≠"

  # ---------------------------------------------------------------
  # 2) APLIKACE RE≈ΩIM≈Æ (Eco / Auto+Boost / Off)
  # ---------------------------------------------------------------
  - choose:
      # ECO
      - conditions:
          - condition: template
            value_template: "{{ mode == 'Eco' }}"
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: "{{ climate_entity }}"
            data:
              hvac_mode: heat

          - condition: template
            value_template: >
              {{ ((state_attr(climate_entity, 'temperature') | float)
                  - (eco_temp | float)) | abs > 0.1 }}

          - service: climate.set_temperature
            target:
              entity_id: "{{ climate_entity }}"
            data:
              temperature: "{{ eco_temp }}"

          - service: logbook.log
            data:
              name: "{{ zone_name }}"
              message: "Glob√°ln√≠ ECO re≈æim ‚Äì c√≠lov√° teplota {{ eco_temp }} ¬∞C"
              entity_id: "{{ climate_entity }}"

      # Auto / Boost
      - conditions:
          - condition: template
            value_template: "{{ mode in ['Auto', 'Boost'] }}"
        sequence:
          - choose:
              # V OKNƒö ‚Üí posledn√≠ komfort
              - conditions:
                  - condition: template
                    value_template: "{{ in_window }}"
                sequence:
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: "{{ climate_entity }}"
                    data:
                      hvac_mode: heat

                  - condition: template
                    value_template: >
                      {{ ((state_attr(climate_entity, 'temperature') | float)
                          - (last_comfort | float)) | abs > 0.1 }}

                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ climate_entity }}"
                    data:
                      temperature: "{{ last_comfort }}"

                  - service: logbook.log
                    data:
                      name: "{{ zone_name }}"
                      message: "Komfortn√≠ re≈æim {{ last_comfort }} ¬∞C (inteligentn√≠ spu≈°tƒõn√≠)"
                      entity_id: "{{ climate_entity }}"

              # MIMO OKNO ‚Üí ECO
              - conditions:
                  - condition: template
                    value_template: "{{ not in_window }}"
                sequence:
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: "{{ climate_entity }}"
                    data:
                      hvac_mode: heat

                  - condition: template
                    value_template: >
                      {{ ((state_attr(climate_entity, 'temperature') | float)
                          - (eco_temp | float)) | abs > 0.1 }}

                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ climate_entity }}"
                    data:
                      temperature: "{{ eco_temp }}"

                  - service: logbook.log
                    data:
                      name: "{{ zone_name }}"
                      message: "ECO {{ eco_temp }} ¬∞C (inteligentn√≠ spu≈°tƒõn√≠)"
                      entity_id: "{{ climate_entity }}"

      # Off
      - conditions:
          - condition: template
            value_template: "{{ mode == 'Off' }}"
        sequence:
          - service: logbook.log
            data:
              name: "{{ zone_name }}"
              message: "Re≈æim Off ‚Äì rozvrh nemƒõn√≠ c√≠lovou teplotu."
              entity_id: "{{ climate_entity }}"
