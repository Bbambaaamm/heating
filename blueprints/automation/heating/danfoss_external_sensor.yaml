blueprint:
  name: "Danfoss ‚Äì extern√≠ teplotn√≠ senzor"
  description: >
    P≈ôepos√≠l√° hodnotu z extern√≠ho teplotn√≠ho senzoru do Danfoss hlavice.
    Pokud je hodnota validn√≠, nastav√≠ number.* pro extern√≠ teplotu
    a zapne switch.* ‚Äûup≈ôednostnit extern√≠ teplotn√≠ senzor‚Äú.
    Pou≈æ√≠v√° se jen v z√≥n√°ch, kde extern√≠ senzor existuje.
  domain: automation

  input:
    zone_name:
      name: N√°zev z√≥ny pro logbook
      description: Jak se m√° z√≥na jmenovat v logu (nap≈ô. 'P≈ô√≠zem√≠ ‚Äì Michal').
      selector:
        text:

    source_temp_sensor:
      name: Extern√≠ teplotn√≠ senzor (zdroj)
      description: Nap≈ô. Zigbee senzor v m√≠stnosti.
      selector:
        entity:
          domain: sensor

    danfoss_external_temp_number:
      name: Danfoss ‚Äì number pro extern√≠ teplotu
      description: number.* pro hlavici (nap≈ô. number.prizemi_michal_senzor_externi_teploty).
      selector:
        entity:
          domain: number

    danfoss_prefer_external_switch:
      name: Danfoss ‚Äì switch up≈ôednostnit extern√≠ senzor
      description: switch.* (nap≈ô. switch.prizemi_michal_uprednostnit_externi_teplotni_senzor).
      selector:
        entity:
          domain: switch

    min_valid_temp:
      name: Minim√°ln√≠ validn√≠ teplota
      description: Hodnoty pod touto teplotou nebudou pos√≠l√°ny do hlavice.
      default: 5
      selector:
        number:
          min: -30
          max: 30
          step: 0.5
          unit_of_measurement: "¬∞C"

    max_valid_temp:
      name: Maxim√°ln√≠ validn√≠ teplota
      description: Hodnoty nad touto teplotou nebudou pos√≠l√°ny do hlavice.
      default: 35
      selector:
        number:
          min: 10
          max: 60
          step: 0.5
          unit_of_measurement: "¬∞C"

    antispam_delta:
      name: Antispam ‚Äì minim√°ln√≠ zmƒõna (¬∞C)
      description: "Po≈°le se jen kdy≈æ je zmƒõna proti poslednƒõ odeslan√© hodnotƒõ ‚â• tato hodnota."
      default: 0.2
      selector:
        number:
          min: 0.0
          max: 1.0
          step: 0.1
          unit_of_measurement: "¬∞C"
          mode: slider

    antispam_min_interval_sec:
      name: Antispam ‚Äì minim√°ln√≠ interval (s)
      description: "0 = bez omezen√≠. Jinak se po≈°le max 1√ó za X sekund (poƒç√≠t√°no od posledn√≠ zmƒõny number.*)."
      default: 120
      selector:
        number:
          min: 0
          max: 600
          step: 10
          unit_of_measurement: "s"
          mode: slider

mode: restart
initial_state: true

trigger:
  - platform: state
    entity_id: !input source_temp_sensor

condition: []

action:
  - variables:
      zone_name: !input zone_name
      src: !input source_temp_sensor
      num: !input danfoss_external_temp_number
      sw: !input danfoss_prefer_external_switch

      min_valid: !input min_valid_temp
      max_valid: !input max_valid_temp
      delta: !input antispam_delta
      min_interval: !input antispam_min_interval_sec

      raw: "{{ states(src) }}"
      temp: "{{ raw | float(999) }}"
      temp_send: "{{ (raw | float(999)) | round(1) }}"

      last_sent: "{{ states(num) | float(none) }}"
      last_sent_ts: >
        {% set obj = states[num] if num in states else none %}
        {% if obj is none %}
          {{ none }}
        {% else %}
          {{ as_timestamp(obj.last_changed) }}
        {% endif %}
      now_ts: "{{ as_timestamp(now()) }}"

      delta_ok: >
        {% if last_sent is none %}
          true
        {% else %}
          {{ (temp_send - last_sent) | abs >= (delta | float(0.2)) }}
        {% endif %}

      interval_ok: >
        {% set mi = (min_interval | int(0)) %}
        {% if mi == 0 %}
          true
        {% elif last_sent_ts is none %}
          true
        {% else %}
          {{ (now_ts - last_sent_ts) >= mi }}
        {% endif %}

  - choose:
      # üîπ Validn√≠ teplota ‚Üí (antispam) po≈°li do hlavice + zapni preferenci extern√≠ho senzoru
      - conditions:
          - condition: template
            value_template: >
              {{ raw not in ['unavailable', 'unknown', 'none', 'NaN']
                 and min_valid <= temp <= max_valid }}
        sequence:
          # zapnout extern√≠ senzor, pokud je≈°tƒõ nen√≠
          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input danfoss_prefer_external_switch
                    state: "off"
                sequence:
                  - service: switch.turn_on
                    target:
                      entity_id: !input danfoss_prefer_external_switch

          # antispam: delta + interval
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ delta_ok and interval_ok }}"
                sequence:
                  - service: number.set_value
                    target:
                      entity_id: !input danfoss_external_temp_number
                    data:
                      value: "{{ temp_send }}"

                  - service: logbook.log
                    data:
                      name: "{{ zone_name }}"
                      message: "Extern√≠ teplota {{ temp_send }} ¬∞C ‚Üí p≈ôed√°na Danfoss hlavici."
                      entity_id: !input source_temp_sensor

      # üîπ Nevalidn√≠ / nedostupn√° teplota ‚Üí jen zaloguj, nic nepos√≠lej
      - conditions:
          - condition: template
            value_template: >
              {{ raw in ['unavailable', 'unknown', 'none', 'NaN']
                 or temp < min_valid or temp > max_valid }}
        sequence:
          - service: logbook.log
            data:
              name: "{{ zone_name }}"
              message: "Extern√≠ teplota nedostupn√° nebo mimo rozsah ({{ raw }}). Hodnota neodesl√°na do hlavice."
              entity_id: !input source_temp_sensor
