# =====================================================================
# ðŸ§  SCHEDULE ENGINE â€“ pÅ™enastavuje setpointy hlavic podle rozvrhu a reÅ¾imu
# - Start/End udÃ¡losti pro Poâ€“PÃ¡ a Soâ€“Ne u kaÅ¾dÃ© zÃ³ny
# - CÃ­lovÃ¡ teplota vychÃ¡zÃ­ z "sensor.last_user_temp_*"
# - ReÅ¾imy: Auto/Eco/Boost/Off ovlivÅˆujÃ­ vÃ½slednou teplotu
# =====================================================================

# â”€â”€ GlobÃ¡lnÃ­ Å¡ablony pro vÃ½poÄet komfortnÃ­/ÃºtlumovÃ© teploty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
template:
  - sensor:
      # KomfortnÃ­ teplota pro reÅ¾im (mÅ¯Å¾e mÃ­t offset v Eco)
      - name: "heating_mode_comfort_offset_c"
        unique_id: heating_mode_comfort_offset_c
        unit_of_measurement: "Â°C"
        state: >
          {% set mode = states('input_select.topny_rezim') %}
          {# Offset aplikujeme jen v Eco; v Boost/Auto 0 #}
          {{ 1.0 if mode == 'Eco' else 0.0 }}

      # ÃštlumovÃ¡ teplota (globÃ¡lnÃ­ konstanta â€“ mÅ¯Å¾eÅ¡ zmÄ›nit)
      - name: "heating_setback_temp_c"
        unique_id: heating_setback_temp_c
        unit_of_measurement: "Â°C"
        state: "17"

# â”€â”€ PomocnÃ¡ skriptovÃ¡ sekce (DRY): nastavenÃ­ zÃ³ny na komfort/Ãºtlum â”€â”€â”€â”€
script:
  # NastavÃ­ ZÃ“NU na KOMFORT (podle poslednÃ­ uÅ¾ivatelskÃ© teploty + reÅ¾im)
  schedule_set_zone_comfort:
    alias: "Schedule: set zone comfort"
    mode: queued
    fields:
      climate_entity:
        description: "climate.* entita hlavice"
      last_user_temp_sensor:
        description: "sensor.last_user_temp_* pro danou zÃ³nu"
    sequence:
      - variables:
          mode: "{{ states('input_select.topny_rezim') }}"
          base: "{{ states(last_user_temp_sensor) | float(21) }}"
          eco_off: "{{ states('sensor.heating_mode_comfort_offset_c') | float(0) }}"
          target: >
            {% if mode == 'Eco' %}
              {{ (base - eco_off) | round(1) }}
            {% else %}
              {{ base | round(1) }}
            {% endif %}
      - service: climate.set_temperature
        target: { entity_id: "{{ climate_entity }}" }
        data:
          temperature: "{{ target }}"

  # NastavÃ­ ZÃ“NU na ÃšTLUM (globÃ¡lnÃ­ setback temp)
  schedule_set_zone_setback:
    alias: "Schedule: set zone setback"
    mode: queued
    fields:
      climate_entity:
        description: "climate.* entita hlavice"
    sequence:
      - service: climate.set_temperature
        target: { entity_id: "{{ climate_entity }}" }
        data:
          temperature: "{{ states('sensor.heating_setback_temp_c') | float(17) }}"

# â”€â”€ AUTOMATIZACE: Triggery start/stop pro jednotlivÃ© zÃ³ny â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
automation:

  # ========== PÅ˜ÃZEMÃ â€“ MICHAL ==========
  - id: sched_prizemi_michal_start
    alias: "Rozvrh: PÅ™Ã­zemÃ­ Michal â€“ START komfortnÃ­ho okna"
    mode: restart
    trigger:
      # Poâ€“PÃ¡ start
      - platform: time
        at: input_datetime.prizemi_michal_weekday_start
      # Soâ€“Ne start
      - platform: time
        at: input_datetime.prizemi_michal_weekend_start
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_prizemi_michal
        state: "on"
      - condition: template
        value_template: >
          {% set dow = now().weekday() %}  {# 0=Po ... 6=Ne #}
          {# PovolÃ­me, pokud je to Poâ€“PÃ¡ a Äas = weekday_start, NEBO Soâ€“Ne a Äas = weekend_start #}
          {% set t = now().strftime('%H:%M:%S') %}
          {% set wstart = states('input_datetime.prizemi_michal_weekday_start')[11:] %}
          {% set weest  = states('input_datetime.prizemi_michal_weekend_start')[11:] %}
          {{ (dow in [0,1,2,3,4] and t == wstart) or (dow in [5,6] and t == weest) }}
      # Boost a Off majÃ­ speciÃ¡lnÃ­ chovÃ¡nÃ­:
      # - Off: rozvrh ignorujeme â†’ nedÄ›lÃ¡me nic (kotel/hlavice pak jede Ãºtlumem dle Off)
      # - Boost: chceme komfort hned: proto neblokujeme, naopak nechÃ¡me probÄ›hnout
      - condition: template
        value_template: "{{ states('input_select.topny_rezim') != 'Off' }}"
    action:
      - service: script.schedule_set_zone_comfort
        data:
          climate_entity: climate.danfoss_etrv0103
          last_user_temp_sensor: sensor.last_user_temp_prizemi_michal

  - id: sched_prizemi_michal_end
    alias: "Rozvrh: PÅ™Ã­zemÃ­ Michal â€“ KONEC komfortnÃ­ho okna â†’ Ãºtlum"
    mode: restart
    trigger:
      - platform: time
        at: input_datetime.prizemi_michal_weekday_end
      - platform: time
        at: input_datetime.prizemi_michal_weekend_end
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_prizemi_michal
        state: "on"
      - condition: template
        value_template: >
          {% set dow = now().weekday() %}
          {% set t = now().strftime('%H:%M:%S') %}
          {% set wend = states('input_datetime.prizemi_michal_weekday_end')[11:] %}
          {% set ween = states('input_datetime.prizemi_michal_weekend_end')[11:] %}
          {{ (dow in [0,1,2,3,4] and t == wend) or (dow in [5,6] and t == ween) }}
      # Pokud je Boost aktivnÃ­, Ãºtlum NEPOSÃLÃME (Boost mÃ¡ pÅ™ednost).
      - condition: template
        value_template: "{{ states('binary_sensor.kotel_boost_active') == 'off' }}"
    action:
      - service: script.schedule_set_zone_setback
        data:
          climate_entity: climate.danfoss_etrv0103

  # ========== 1. PATRO â€“ KUCHYÅ‡+JÃDELNA ==========
  - id: sched_1p_kuchyn_start
    alias: "Rozvrh: 1.patro KuchyÅˆ â€“ START komfortnÃ­ho okna"
    mode: restart
    trigger:
      - platform: time
        at: input_datetime.kuchyn_weekday_start
      - platform: time
        at: input_datetime.kuchyn_weekend_start
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_1p_kuchyn
        state: "on"
      - condition: template
        value_template: >
          {% set dow = now().weekday() %}
          {% set t = now().strftime('%H:%M:%S') %}
          {% set wstart = states('input_datetime.kuchyn_weekday_start')[11:] %}
          {% set weest  = states('input_datetime.kuchyn_weekend_start')[11:] %}
          {{ (dow in [0,1,2,3,4] and t == wstart) or (dow in [5,6] and t == weest) }}
      - condition: template
        value_template: "{{ states('input_select.topny_rezim') != 'Off' }}"
    action:
      - service: script.schedule_set_zone_comfort
        data:
          climate_entity: climate.1_patro_kuchyn
          last_user_temp_sensor: sensor.last_user_temp_1p_kuchyn

  - id: sched_1p_kuchyn_end
    alias: "Rozvrh: 1.patro KuchyÅˆ â€“ KONEC komfortnÃ­ho okna â†’ Ãºtlum"
    mode: restart
    trigger:
      - platform: time
        at: input_datetime.kuchyn_weekday_end
      - platform: time
        at: input_datetime.kuchyn_weekend_end
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_1p_kuchyn
        state: "on"
      - condition: template
        value_template: >
          {% set dow = now().weekday() %}
          {% set t = now().strftime('%H:%M:%S') %}
          {% set wend = states('input_datetime.kuchyn_weekday_end')[11:] %}
          {% set ween = states('input_datetime.kuchyn_weekend_end')[11:] %}
          {{ (dow in [0,1,2,3,4] and t == wend) or (dow in [5,6] and t == ween) }}
      - condition: template
        value_template: "{{ states('binary_sensor.kotel_boost_active') == 'off' }}"
    action:
      - service: script.schedule_set_zone_setback
        data:
          climate_entity: climate.1_patro_kuchyn

  # ========== 2. PATRO â€“ MÃMA ==========
  - id: sched_2p_mama_start
    alias: "Rozvrh: 2.patro MÃ¡ma â€“ START komfortnÃ­ho okna"
    mode: restart
    trigger:
      - platform: time
        at: input_datetime.mama_weekday_start
      - platform: time
        at: input_datetime.mama_weekend_start
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_2p_mama
        state: "on"
      - condition: template
        value_template: >
          {% set dow = now().weekday() %}
          {% set t = now().strftime('%H:%M:%S') %}
          {% set wstart = states('input_datetime.mama_weekday_start')[11:] %}
          {% set weest  = states('input_datetime.mama_weekend_start')[11:] %}
          {{ (dow in [0,1,2,3,4] and t == wstart) or (dow in [5,6] and t == weest) }}
      - condition: template
        value_template: "{{ states('input_select.topny_rezim') != 'Off' }}"
    action:
      - service: script.schedule_set_zone_comfort
        data:
          climate_entity: climate.danfoss_etrv0103_2
          last_user_temp_sensor: sensor.last_user_temp_2p_mama

  - id: sched_2p_mama_end
    alias: "Rozvrh: 2.patro MÃ¡ma â€“ KONEC komfortnÃ­ho okna â†’ Ãºtlum"
    mode: restart
    trigger:
      - platform: time
        at: input_datetime.mama_weekday_end
      - platform: time
        at: input_datetime.mama_weekend_end
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_2p_mama
        state: "on"
      - condition: template
        value_template: >
          {% set dow = now().weekday() %}
          {% set t = now().strftime('%H:%M:%S') %}
          {% set wend = states('input_datetime.mama_weekday_end')[11:] %}
          {% set ween = states('input_datetime.mama_weekend_end')[11:] %}
          {{ (dow in [0,1,2,3,4] and t == wend) or (dow in [5,6] and t == ween) }}
      - condition: template
        value_template: "{{ states('binary_sensor.kotel_boost_active') == 'off' }}"
    action:
      - service: script.schedule_set_zone_setback
        data:
          climate_entity: climate.danfoss_etrv0103_2
