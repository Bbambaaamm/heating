# =====================================================================
# Soubor   : config/heating/schedule/schedule_engine.yaml
# Modul    : Schedule Engine â€“ sdÃ­lenÃ¡ logika rozvrhÅ¯ (vÃ­ce zÃ³n)
# ÃšÄel     : VÃ½poÄet komfortnÃ­ho offsetu / setbacku + sdÃ­lenÃ© skripty
# Autor    : Michal
# PoslednÃ­ Ãºprava : 2025-11-19
# =====================================================================
# ğŸ“Œ PÅ™ehled:
# - senzory:
#     â€¢ sensor.heating_mode_comfort_offset_c  â†’ offset komfortu dle reÅ¾imu
#     â€¢ sensor.heating_setback_temp_c         â†’ globÃ¡lnÃ­ ÃºtlumovÃ¡ teplota
# - skripty:
#     â€¢ script.schedule_set_zone_comfort      â†’ nastavÃ­ komfort pro zÃ³nu
#     â€¢ script.schedule_set_zone_setback      â†’ nastavÃ­ Ãºtlum pro zÃ³nu
#
# PouÅ¾itÃ­:
# - volajÃ­ je start/end automatizace rozvrhÅ¯ jednotlivÃ½ch zÃ³n
# - reÅ¾im Auto/Eco/Boost/Off se promÃ­tÃ¡ do vÃ½poÄtu cÃ­lovÃ© teploty
# =====================================================================

template:
  - sensor:
      # ----------------------------------------------------------------
      # Offset komfortnÃ­ teploty podle reÅ¾imu (Eco sniÅ¾uje komfort)
      # ----------------------------------------------------------------
      - name: "heating_mode_comfort_offset_c"
        unique_id: heating_mode_comfort_offset_c
        unit_of_measurement: "Â°C"
        state: >-
          {% set mode = states('input_select.topny_rezim') %}
          {{ 1.0 if mode == 'Eco' else 0.0 }}

      # ----------------------------------------------------------------
      # GlobÃ¡lnÃ­ ÃºtlumovÃ¡ teplota (setback)
      # ----------------------------------------------------------------
      - name: "heating_setback_temp_c"
        unique_id: heating_setback_temp_c
        unit_of_measurement: "Â°C"
        state: "17"   # pÅ™Ã­padnou zmÄ›nu Å™eÅ¡ pÅ™es UI nebo separÃ¡tnÃ­ helper

# =====================================================================
# Skripty â€“ sdÃ­lenÃ¡ logika pro komfort a Ãºtlum
# =====================================================================

script:

  # -------------------------------------------------------------------
  # script.schedule_set_zone_comfort
  # NastavÃ­ danou climate entitu na komfortnÃ­ teplotu (s ohledem na reÅ¾im)
  # -------------------------------------------------------------------
  schedule_set_zone_comfort:
    alias: "Schedule: set zone comfort"
    mode: queued
    fields:
      climate_entity:
        description: "Target climate.* entita hlavice"
      last_user_temp_sensor:
        description: "Helper/senzor s poslednÃ­ komfortnÃ­ teplotou zÃ³ny"
    sequence:
      - variables:
          mode: "{{ states('input_select.topny_rezim') }}"
          base: "{{ states(last_user_temp_sensor) | float(21) }}"
          eco_off: "{{ states('sensor.heating_mode_comfort_offset_c') | float(0) }}"
          target: >-
            {% if mode == 'Eco' %}
              {{ (base - eco_off) | round(1) }}
            {% else %}
              {{ base | round(1) }}
            {% endif %}

      # PÅ™epnout na heat jen pokud uÅ¾ nenÃ­, aÅ¥ zbyteÄnÄ› nehÃ½beme reÅ¾imem
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states(climate_entity) | lower != 'heat' }}"
            sequence:
              - action: climate.set_hvac_mode
                data:
                  entity_id: "{{ climate_entity }}"
                  hvac_mode: heat

      # Guard: zapisuj jen pokud se teplota reÃ¡lnÄ› liÅ¡Ã­ (Â±0.1 Â°C)
      - condition: template
        value_template: >-
          {{ (state_attr(climate_entity,'temperature') | float(0)
              - (target | float(0))) | abs > 0.1 }}

      # NastavenÃ­ komfortnÃ­ teploty
      - action: climate.set_temperature
        data:
          entity_id: "{{ climate_entity }}"
          temperature: "{{ target }}"

      # Logbook â€“ jen pÅ™i reÃ¡lnÃ© zmÄ›nÄ›
      - action: logbook.log
        data:
          name: "{{ climate_entity.split('.')[-1] | replace('_',' ') | title }}"
          message: "Rozvrh â€“ nastavena komfortnÃ­ teplota: {{ target }} Â°C"
          entity_id: "{{ climate_entity }}"

  # -------------------------------------------------------------------
  # script.schedule_set_zone_setback
  # NastavÃ­ danou climate entitu na Ãºtlumovou teplotu (setback)
  # -------------------------------------------------------------------
  schedule_set_zone_setback:
    alias: "Schedule: set zone setback"
    mode: queued
    fields:
      climate_entity:
        description: "Target climate.* entita hlavice"
    sequence:
      - variables:
          setback: "{{ states('sensor.heating_setback_temp_c') | float(17) }}"

      # NÄ›kterÃ© hlavice ignorujÃ­ set_temperature v reÅ¾imu off â†’ hlÃ­dej heat
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states(climate_entity) | lower != 'heat' }}"
            sequence:
              - action: climate.set_hvac_mode
                data:
                  entity_id: "{{ climate_entity }}"
                  hvac_mode: heat

      # Guard: zapisuj jen pokud se teplota reÃ¡lnÄ› liÅ¡Ã­ (Â±0.1 Â°C)
      - condition: template
        value_template: >-
          {{ (state_attr(climate_entity,'temperature') | float(0)
              - (setback | float(0))) | abs > 0.1 }}

      # NastavenÃ­ ÃºtlumovÃ© teploty
      - action: climate.set_temperature
        data:
          entity_id: "{{ climate_entity }}"
          temperature: "{{ setback }}"

      # Logbook â€“ jen pÅ™i reÃ¡lnÃ© zmÄ›nÄ›
      - action: logbook.log
        data:
          name: "{{ climate_entity.split('.')[-1] | replace('_',' ') | title }}"
          message: "Rozvrh â€“ nastavena ÃºtlumovÃ¡ teplota: {{ setback }} Â°C"
          entity_id: "{{ climate_entity }}"
