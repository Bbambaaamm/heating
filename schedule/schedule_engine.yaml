# YAML 2024.10
# =====================================================================
# ğŸ§  SOUBOR: /config/heating/schedule/schedule_engine.yaml
# =====================================================================
# ROZVRH â€“ SCHEDULE ENGINE (vÃ­ce zÃ³n)
# ---------------------------------------------------------------------
# CÃ­l:
# PÅ™enastavit teploty hlavic podle rozvrhovÃ½ch ÄasÅ¯ (start/end)
# a aktuÃ¡lnÃ­ho topnÃ©ho reÅ¾imu (Auto / Eco / Boost / Off).
#
# ZÃ¡kladnÃ­ logika:
# - PoÄÃ­tÃ¡ komfortnÃ­ teplotu z poslednÃ­ uÅ¾ivatelskÃ© hodnoty (sensor.last_user_temp_*)
# - Aplikuje offset v reÅ¾imu Eco (napÅ™. â€“1 Â°C)
# - Na konci komfortnÃ­ho okna nastavÃ­ Ãºtlumovou teplotu (setback)
#
# Vstupy:
# - input_datetime.*_start / *_end (Äasy rozvrhu)
# - input_boolean.schedule_enable_* (aktivace rozvrhu)
# - input_select.topny_rezim (globÃ¡lnÃ­ reÅ¾im topenÃ­)
#
# VÃ½stupy:
# - climate.* (nastavenÃ­ teploty hlavic)
# =====================================================================

# ---------------------------------------------------------------------
# GlobÃ¡lnÃ­ Å¡ablony â€“ vÃ½poÄet komfortnÃ­ho offsetu a ÃºtlumovÃ© teploty
# ---------------------------------------------------------------------
template:
  - sensor:
      # Offset komfortnÃ­ teploty podle reÅ¾imu (Eco sniÅ¾uje o 1 Â°C)
      - name: "heating_mode_comfort_offset_c"
        unique_id: heating_mode_comfort_offset_c
        unit_of_measurement: "Â°C"
        state: >
          {% set mode = states('input_select.topny_rezim') %}
          {{ 1.0 if mode == 'Eco' else 0.0 }}                  # v reÅ¾imu Eco pouÅ¾ij offset 1Â°C, jinak 0

      # GlobÃ¡lnÃ­ ÃºtlumovÃ¡ teplota (setback)
      - name: "heating_setback_temp_c"
        unique_id: heating_setback_temp_c
        unit_of_measurement: "Â°C"
        state: "17" # konstantnÃ­ hodnota (pÅ™Ã­padnÄ› zmÄ›Åˆ)

# ---------------------------------------------------------------------
# PomocnÃ© skripty â€“ sdÃ­lenÃ¡ logika pro komfort a Ãºtlum
# ---------------------------------------------------------------------
script:
  # NastavÃ­ danou zÃ³nu na komfortnÃ­ teplotu
  schedule_set_zone_comfort:
    alias: "Schedule: set zone comfort"
    mode: queued
    fields:
      climate_entity: # cÃ­lovÃ¡ climate.* entita
        description: "climate.* entita hlavice"
      last_user_temp_sensor: # zdroj poslednÃ­ komfortnÃ­ teploty
        description: "sensor.last_user_temp_* pro danou zÃ³nu"
    sequence:
      - variables:
          mode: "{{ states('input_select.topny_rezim') }}" # aktuÃ¡lnÃ­ reÅ¾im topenÃ­
          base: "{{ states(last_user_temp_sensor) | float(21) }}" # vÃ½chozÃ­ komfort (fallback 21)
          eco_off: "{{ states('sensor.heating_mode_comfort_offset_c') | float(0) }}" # offset v Eco
          target: > # vÃ½slednÃ¡ cÃ­lovÃ¡ teplota
            {% if mode == 'Eco' %}
              {{ (base - eco_off) | round(1) }}
            {% else %}
              {{ base | round(1) }}
            {% endif %}

      # PÅ™epni na heat jen pokud uÅ¾ nenÃ­, aÅ¥ neprovokujeme zbyteÄnÃ© zmÄ›ny reÅ¾imu
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states(climate_entity) | lower != 'heat' }}" # nenÃ­ v reÅ¾imu heat?
            sequence:
              - action: climate.set_hvac_mode
                data:
                  entity_id: "{{ climate_entity }}" # cÃ­lovÃ¡ hlavice
                  hvac_mode: heat # zapnout topenÃ­

      # Guard: nepiÅ¡ stejnou teplotu znovu (Â±0.1 Â°C tolerance)
      - condition: template
        value_template: >
          {{ (state_attr(climate_entity, 'temperature') | float(0) - (target | float(0))) | abs > 0.1 }}

      # Nastav cÃ­lovou teplotu
      - action: climate.set_temperature
        data:
          entity_id: "{{ climate_entity }}" # cÃ­lovÃ¡ hlavice
          temperature: "{{ target }}" # vypoÄtenÃ¡ komfortnÃ­ teplota

      # ZÃ¡znam do logbooku â€“ pouze pÅ™i reÃ¡lnÃ© zmÄ›nÄ›
      - action: logbook.log
        data:
          name: "{{ climate_entity.split('.')[-1] | replace('_',' ') | title }}"
          message: "Rozvrh â€“ nastavena komfortnÃ­ teplota: {{ target }} Â°C"
          entity_id: "{{ climate_entity }}"

  # NastavÃ­ danou zÃ³nu na Ãºtlumovou teplotu (setback)
  schedule_set_zone_setback:
    alias: "Schedule: set zone setback"
    mode: queued
    fields:
      climate_entity:
        description: "climate.* entita hlavice"
    sequence:
      - variables:
          setback: "{{ states('sensor.heating_setback_temp_c') | float(17) }}" # cÃ­lovÃ½ Ãºtlum

      # PÅ™epni na heat jen pokud uÅ¾ nenÃ­ (nÄ›kterÃ© hlavice ignorujÃ­ set_temperature v off)
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states(climate_entity) | lower != 'heat' }}"
            sequence:
              - action: climate.set_hvac_mode
                data:
                  entity_id: "{{ climate_entity }}"
                  hvac_mode: heat

      # Guard: nepiÅ¡ stejnou teplotu znovu (Â±0.1 Â°C)
      - condition: template
        value_template: >
          {{ (state_attr(climate_entity, 'temperature') | float(0) - (setback | float(0))) | abs > 0.1 }}

      # Nastav Ãºtlumovou teplotu
      - action: climate.set_temperature
        data:
          entity_id: "{{ climate_entity }}"
          temperature: "{{ setback }}"

      # ZÃ¡znam do logbooku â€“ pouze pÅ™i reÃ¡lnÃ© zmÄ›nÄ›
      - action: logbook.log
        data:
          name: "{{ climate_entity.split('.')[-1] | replace('_',' ') | title }}"
          message: "Rozvrh â€“ nastavena ÃºtlumovÃ¡ teplota: {{ setback }} Â°C"
          entity_id: "{{ climate_entity }}"
