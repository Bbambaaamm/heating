# YAML 2024.10
# =====================================================================
# üß† SOUBOR: /config/heating/schedule/schedule_engine.yaml
# =====================================================================
# ROZVRH ‚Äì SCHEDULE ENGINE (v√≠ce z√≥n)
# ---------------------------------------------------------------------
# C√≠l:
# P≈ôenastavit teploty hlavic podle rozvrhov√Ωch ƒças≈Ø (start/end)
# a aktu√°ln√≠ho topn√©ho re≈æimu (Auto / Eco / Boost / Off).
#
# Z√°kladn√≠ logika:
# - Poƒç√≠t√° komfortn√≠ teplotu z posledn√≠ u≈æivatelsk√© hodnoty (sensor.last_user_temp_*)
# - Aplikuje offset v re≈æimu Eco (nap≈ô. ‚Äì1 ¬∞C)
# - Na konci komfortn√≠ho okna nastav√≠ √∫tlumovou teplotu (setback)
#
# Vstupy:
# - input_datetime.*_start / *_end (ƒçasy rozvrhu)
# - input_boolean.schedule_enable_* (aktivace rozvrhu)
# - input_select.topny_rezim (glob√°ln√≠ re≈æim topen√≠)
#
# V√Ωstupy:
# - climate.* (nastaven√≠ teploty hlavic)
# =====================================================================

# ---------------------------------------------------------------------
# Glob√°ln√≠ ≈°ablony ‚Äì v√Ωpoƒçet komfortn√≠ho offsetu a √∫tlumov√© teploty
# ---------------------------------------------------------------------
template:
  - sensor:
      # Offset komfortn√≠ teploty podle re≈æimu (Eco sni≈æuje o 1 ¬∞C)
      - name: "heating_mode_comfort_offset_c"
        unique_id: heating_mode_comfort_offset_c
        unit_of_measurement: "¬∞C"
        state: >
          {% set mode = states('input_select.topny_rezim') %}
          {{ 1.0 if mode == 'Eco' else 0.0 }}                  # v re≈æimu Eco pou≈æij offset 1¬∞C, jinak 0

      # Glob√°ln√≠ √∫tlumov√° teplota (setback)
      - name: "heating_setback_temp_c"
        unique_id: heating_setback_temp_c
        unit_of_measurement: "¬∞C"
        state: "17" # konstantn√≠ hodnota (p≈ô√≠padnƒõ zmƒõ≈à)

# ---------------------------------------------------------------------
# Pomocn√© skripty ‚Äì sd√≠len√° logika pro komfort a √∫tlum
# ---------------------------------------------------------------------
script:
  # Nastav√≠ danou z√≥nu na komfortn√≠ teplotu
  schedule_set_zone_comfort:
    alias: "Schedule: set zone comfort"
    mode: queued
    fields:
      climate_entity: # c√≠lov√° climate.* entita
        description: "climate.* entita hlavice"
      last_user_temp_sensor: # zdroj posledn√≠ komfortn√≠ teploty
        description: "sensor.last_user_temp_* pro danou z√≥nu"
    sequence:
      - variables:
          mode: "{{ states('input_select.topny_rezim') }}" # aktu√°ln√≠ re≈æim topen√≠
          base: "{{ states(last_user_temp_sensor) | float(21) }}" # v√Ωchoz√≠ komfort (fallback 21)
          eco_off: "{{ states('sensor.heating_mode_comfort_offset_c') | float(0) }}" # offset v Eco
          target: > # v√Ωsledn√° c√≠lov√° teplota
            {% if mode == 'Eco' %}
              {{ (base - eco_off) | round(1) }}
            {% else %}
              {{ base | round(1) }}
            {% endif %}

      # P≈ôepni na heat jen pokud u≈æ nen√≠, a≈• neprovokujeme zbyteƒçn√© zmƒõny re≈æimu
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states(climate_entity) | lower != 'heat' }}" # nen√≠ v re≈æimu heat?
            sequence:
              - action: climate.set_hvac_mode
                data:
                  entity_id: "{{ climate_entity }}" # c√≠lov√° hlavice
                  hvac_mode: heat # zapnout topen√≠

      # Guard: nepi≈° stejnou teplotu znovu (¬±0.1 ¬∞C tolerance)
      - condition: template
        value_template: >
          {{ (state_attr(climate_entity, 'temperature') | float(0) - (target | float(0))) | abs > 0.1 }}

      # Nastav c√≠lovou teplotu
      - action: climate.set_temperature
        data:
          entity_id: "{{ climate_entity }}" # c√≠lov√° hlavice
          temperature: "{{ target }}" # vypoƒçten√° komfortn√≠ teplota

      # Z√°znam do logbooku ‚Äì pouze p≈ôi re√°ln√© zmƒõnƒõ
      - action: logbook.log
        data:
          name: "{{ climate_entity.split('.')[-1] | replace('_',' ') | title }}"
          message: "Rozvrh ‚Äì nastavena komfortn√≠ teplota: {{ target }} ¬∞C"
          entity_id: "{{ climate_entity }}"

  # Nastav√≠ danou z√≥nu na √∫tlumovou teplotu (setback)
  schedule_set_zone_setback:
    alias: "Schedule: set zone setback"
    mode: queued
    fields:
      climate_entity:
        description: "climate.* entita hlavice"
    sequence:
      - variables:
          setback: "{{ states('sensor.heating_setback_temp_c') | float(17) }}" # c√≠lov√Ω √∫tlum

      # P≈ôepni na heat jen pokud u≈æ nen√≠ (nƒõkter√© hlavice ignoruj√≠ set_temperature v off)
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states(climate_entity) | lower != 'heat' }}"
            sequence:
              - action: climate.set_hvac_mode
                data:
                  entity_id: "{{ climate_entity }}"
                  hvac_mode: heat

      # Guard: nepi≈° stejnou teplotu znovu (¬±0.1 ¬∞C)
      - condition: template
        value_template: >
          {{ (state_attr(climate_entity, 'temperature') | float(0) - (setback | float(0))) | abs > 0.1 }}

      # Nastav √∫tlumovou teplotu
      - action: climate.set_temperature
        data:
          entity_id: "{{ climate_entity }}"
          temperature: "{{ setback }}"

      # Z√°znam do logbooku ‚Äì pouze p≈ôi re√°ln√© zmƒõnƒõ
      - action: logbook.log
        data:
          name: "{{ climate_entity.split('.')[-1] | replace('_',' ') | title }}"
          message: "Rozvrh ‚Äì nastavena √∫tlumov√° teplota: {{ setback }} ¬∞C"
          entity_id: "{{ climate_entity }}"

# ---------------------------------------------------------------------
# AUTOMATIZACE ‚Äì ud√°losti start/end pro jednotliv√© z√≥ny
# ---------------------------------------------------------------------
automation:
  # ==============================================================================================================================================================================
  # P≈ò√çZEM√ç ‚Äì MICHAL
  # ==============================================================================================================================================================================

  - id: sched_prizemi_michal_start
    alias: "Rozvrh: P≈ô√≠zem√≠ Michal ‚Äì START komfortn√≠ho okna"
    mode: restart
    triggers:
      - trigger: template
        value_template: "{{ now().strftime('%H:%M') == start_time[:5] }}" # start Po,√∫t,st,ƒçt,p√°,so,ne
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_prizemi_michal
        state: "on" # rozvrh aktivn√≠
      - condition: template
        value_template: "{{ states('input_select.topny_rezim') != 'Off' }}" # Off = nic nedƒõlej
    actions:
      - action: script.schedule_set_zone_comfort
        data:
          climate_entity: climate.prizemi_michal # c√≠lov√° hlavice
          last_user_temp_sensor: sensor.last_user_temp_prizemi_michal

  - id: sched_prizemi_michal_end
    alias: "Rozvrh: P≈ô√≠zem√≠ Michal ‚Äì KONEC komfortn√≠ho okna ‚Üí √∫tlum"
    mode: restart
    triggers:
      - trigger: template
        value_template: "{{ now().strftime('%H:%M') == end_time[:5] }}" # end Po,√∫t,st,ƒçt,p√°,so,ne
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_prizemi_michal
        state: "on"
      - condition: template
        value_template: "{{ states('binary_sensor.kotel_boost_active') == 'off' }}" # Boost m√° p≈ôednost
    actions:
      - action: script.schedule_set_zone_setback
        data:
          climate_entity: climate.prizemi_michal

  # ==============================================================================================================================================================================
  # 1. PATRO ‚Äì KUCHY≈á
  # ==============================================================================================================================================================================

  - id: sched_1p_jidelna_start
    alias: "Rozvrh: 1. patro Kuchy≈à ‚Äì START komfortn√≠ho okna"
    mode: restart
    triggers:
      - trigger: template
        value_template: "{{ now().strftime('%H:%M') == start_time[:5] }}" # start Po,√∫t,st,ƒçt,p√°,so,ne
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_1p_jidelna
        state: "on"
      - condition: template
        value_template: "{{ states('input_select.topny_rezim') != 'Off' }}" # Off = nic nedƒõlej
    actions:
      - action: script.schedule_set_zone_comfort
        data:
          climate_entity: climate.1p_jidelna
          last_user_temp_sensor: sensor.last_user_temp_1p_jidelna

  - id: sched_1p_jidelna_end
    alias: "Rozvrh: 1. patro Kuchy≈à ‚Äì KONEC komfortn√≠ho okna ‚Üí √∫tlum"
    mode: restart
    triggers:
      - trigger: template
        value_template: "{{ now().strftime('%H:%M') == end_time[:5] }}" # end Po,√∫t,st,ƒçt,p√°,so,ne
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_1p_jidelna
        state: "on"
      - condition: template
        value_template: "{{ states('binary_sensor.kotel_boost_active') == 'off' }}" # Boost m√° p≈ôednost
    actions:
      - action: script.schedule_set_zone_setback
        data:
          climate_entity: climate.1p_jidelna

  # ==============================================================================================================================================================================
  # 2. PATRO ‚Äì M√ÅMA
  # ==============================================================================================================================================================================

  - id: sched_2p_mama_start
    alias: "Rozvrh: 2. patro M√°ma ‚Äì START komfortn√≠ho okna"
    mode: restart
    triggers:
      - trigger: template
        value_template: "{{ now().strftime('%H:%M') == start_time[:5] }}" # start Po,√∫t,st,ƒçt,p√°,so,ne
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_2p_mama
        state: "on"
      - condition: template
        value_template: "{{ states('input_select.topny_rezim') != 'Off' }}" # Off = nic nedƒõlej
    actions:
      - action: script.schedule_set_zone_comfort
        data:
          climate_entity: climate.2p_mama
          last_user_temp_sensor: sensor.last_user_temp_2p_mama

  - id: sched_2p_mama_end
    alias: "Rozvrh: 2. patro M√°ma ‚Äì KONEC komfortn√≠ho okna ‚Üí √∫tlum"
    mode: restart
    triggers:
      - trigger: template
        value_template: "{{ now().strftime('%H:%M') == end_time[:5] }}" # start Po,√∫t,st,ƒçt,p√°,so,ne
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_2p_mama
        state: "on"
      - condition: template
        value_template: "{{ states('binary_sensor.kotel_boost_active') == 'off' }}" # Boost m√° p≈ôednost
    actions:
      - action: script.schedule_set_zone_setback
        data:
          climate_entity: climate.2p_mama
