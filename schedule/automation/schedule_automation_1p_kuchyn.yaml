# =====================================================================
# ðŸ“… Rozvrh â€“ 1. patro (KuchyÅˆ) â€“ dynamickÃ¡ aktualizace (V2)
# - Vyhodnocuje komfort/ECO kaÅ¾dou minutu a pÅ™i zmÄ›nÄ› rozvrhovÃ½ch entit
# - START okna â†’ nastavÃ­ poslednÃ­ uÅ¾ivatelskou teplotu (input_number.1p_kuchyn_last_comfort)
# - KONEC okna â†’ nastavÃ­ ECO teplotu (input_number.eco_temp_default)
# - PorovnÃ¡vÃ¡nÃ­ Äasu dÄ›lÃ¡me robustnÄ› pÅ™es today_at() + hour/minute atributy
# - LogovÃ¡nÃ­ do Logbooku pomocÃ­ sluÅ¾by logbook.log (Å¾Ã¡dnÃ© log_message)
#
# POZN.:
# - Tento soubor pÅ™edpoklÃ¡dÃ¡, Å¾e mÃ¡Å¡ pomocnÃ­ka:
#     input_number.1p_kuchyn_last_comfort
#   (aktualizovanÃ©ho automatizacÃ­ â€žcapture last comfortâ€œ pÅ™i ruÄnÃ­ zmÄ›nÄ› teploty)
# =====================================================================

automation:
  - alias: "Rozvrh 1P KuchyÅˆ â€“ dynamickÃ¡ aktualizace"
    id: schedule_1p_kuchyn_dynamic_v2
    mode: restart
    initial_state: true
    description: >
      Vyhodnocuje komfort/ECO podle rozvrhu 1. patro â€“ KuchyÅˆ. SpouÅ¡tÃ­ se kaÅ¾dou minutu
      i pÅ™i zmÄ›nÄ› Äasu/enable/ECO/last_comfort. OÅ¡etÅ™uje intervaly pÅ™es pÅ¯lnoc.

    # ðŸ›Žï¸ SpouÅ¡tÄ›Äe: kaÅ¾dÃ¡ minuta + zmÄ›na relevantnÃ­ch entit
    trigger:
      - platform: time_pattern
        minutes: "/1"
      - platform: state
        entity_id:
          - input_datetime.kuchyn_weekday_start
          - input_datetime.kuchyn_weekday_end
          - input_datetime.kuchyn_weekend_start
          - input_datetime.kuchyn_weekend_end
          - input_boolean.schedule_enable_1p_kuchyn
          - input_number.eco_temp_default
          - input_number.1p_kuchyn_last_comfort

    # ðŸ“¦ VypoÄÃ­tanÃ© promÄ›nnÃ© (kaÅ¾dÃ© spuÅ¡tÄ›nÃ­)
    variables:
      # ðŸ”€ Vyber sprÃ¡vnÃ© entity start/end podle dne (Poâ€“PÃ¡ / Soâ€“Ne)
      start_ent: >
        {% if now().isoweekday() in [1,2,3,4,5] %}
          input_datetime.kuchyn_weekday_start
        {% else %}
          input_datetime.kuchyn_weekend_start
        {% endif %}
      end_ent: >
        {% if now().isoweekday() in [1,2,3,4,5] %}
          input_datetime.kuchyn_weekday_end
        {% else %}
          input_datetime.kuchyn_weekend_end
        {% endif %}

      # â±ï¸ Sestav dneÅ¡nÃ­ datovÃ© Äasy start/end z H/M atributÅ¯ (funguje i bez data)
      start_dt: >
        {% set sh = state_attr(start_ent, 'hour')   | int(0) %}
        {% set sm = state_attr(start_ent, 'minute') | int(0) %}
        {{ today_at('{:02d}:{:02d}:00'.format(sh, sm)) }}
      end_dt: >
        {% set eh = state_attr(end_ent, 'hour')   | int(0) %}
        {% set em = state_attr(end_ent, 'minute') | int(0) %}
        {{ today_at('{:02d}:{:02d}:00'.format(eh, em)) }}
      now_dt: "{{ now() }}"

      # ðŸŒ¿ ECO a poslednÃ­ komfortnÃ­ teplota (fallbacky, kdyby helper chybÄ›l)
      eco_temp: "{{ states('input_number.eco_temp_default') | float(18) }}"
      last_set: "{{ states('input_number.1p_kuchyn_last_comfort') | float(21.5) }}"

      # ðŸ“ Jsme uvnitÅ™ okna? (Å™eÅ¡Ã­ i pÅ™Ã­pad pÅ™es pÅ¯lnoc)
      in_window: >
        {% if start_dt <= end_dt %}
          {{ start_dt <= now_dt < end_dt }}
        {% else %}
          {{ (now_dt >= start_dt) or (now_dt < end_dt) }}
        {% endif %}

    # âœ… Rozvrh pro zÃ³nu musÃ­ bÃ½t povolen
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_1p_kuchyn
        state: "on"

    # â–¶ï¸ Akce podle toho, zda jsme v oknÄ› (komfort) nebo mimo (ECO)
    action:
      - choose:
          # ðŸŸ¢ UVNITÅ˜ OKNA â†’ komfortnÃ­ teplota = poslednÃ­ uÅ¾ivatelskÃ¡
          - conditions:
              - condition: template
                value_template: "{{ in_window }}"
            sequence:
              - service: climate.set_hvac_mode
                target:
                  entity_id: climate.1_patro_kuchyn
                data:
                  hvac_mode: heat
              - service: climate.set_temperature
                target:
                  entity_id: climate.1_patro_kuchyn
                data:
                  temperature: "{{ last_set }}"
              - service: logbook.log
                data:
                  name: "Rozvrh 1P KuchyÅˆ"
                  message: "START/UVNITÅ˜ OKNA â†’ nastavena komfortnÃ­ {{ last_set }} Â°C"
                  entity_id: climate.1_patro_kuchyn

          # ðŸŒ¿ MIMO OKNO â†’ ECO teplota
          - conditions:
              - condition: template
                value_template: "{{ not in_window }}"
            sequence:
              - service: climate.set_hvac_mode
                target:
                  entity_id: climate.1_patro_kuchyn
                data:
                  hvac_mode: heat
              - service: climate.set_temperature
                target:
                  entity_id: climate.1_patro_kuchyn
                data:
                  temperature: "{{ eco_temp }}"
              - service: logbook.log
                data:
                  name: "Rozvrh 1P KuchyÅˆ"
                  message: "KONEC/MIMO OKNO â†’ nastavena ECO {{ eco_temp }} Â°C"
                  entity_id: climate.1_patro_kuchyn
