# =====================================================================
# ğŸ•’ ROZVRH 2P MÃMA â€“ InteligentnÃ­ (spouÅ¡tÃ­ jen pÅ™i zmÄ›nÄ›)
# =====================================================================

automation:
  - alias: "Rozvrh 2P MÃ¡ma â€“ inteligentnÃ­ spouÅ¡tÄ›nÃ­"
    id: schedule_2p_mama_smart
    mode: restart
    initial_state: true

    trigger:
      # â–¶ï¸ KdyÅ¾ nastane Äas startu nebo konce rozvrhu
      - platform: time
        at:
          - input_datetime.mama_weekday_start
          - input_datetime.mama_weekday_end
          - input_datetime.mama_weekend_start
          - input_datetime.mama_weekend_end

      # â–¶ï¸ KdyÅ¾ nÄ›kdo zmÄ›nÃ­ Äasy nebo povolenÃ­ rozvrhu
      - platform: state
        entity_id:
          - input_datetime.mama_weekday_start
          - input_datetime.mama_weekday_end
          - input_datetime.mama_weekend_start
          - input_datetime.mama_weekend_end
          - input_boolean.schedule_enable_2p_mama

      # â–¶ï¸ KdyÅ¾ uÅ¾ivatel zmÄ›nÃ­ teplotu na hlavici ruÄnÄ›
      - platform: state
        entity_id: climate.danfoss_etrv0103_2
        attribute: temperature

    variables:
      eco_temp: "{{ states('input_number.eco_temp_default') | float(18) }}"
      last_comfort: "{{ states('input_number.2p_mama_last_comfort') | float(21) }}"

      # ğŸ§­ DneÅ¡nÃ­ start/end podle dne v tÃ½dnu
      start: >
        {% if now().isoweekday() in [1,2,3,4,5] %}
          {{ states('input_datetime.mama_weekday_start') }}
        {% else %}
          {{ states('input_datetime.mama_weekend_start') }}
        {% endif %}
      end: >
        {% if now().isoweekday() in [1,2,3,4,5] %}
          {{ states('input_datetime.mama_weekday_end') }}
        {% else %}
          {{ states('input_datetime.mama_weekend_end') }}
        {% endif %}

    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_2p_mama
        state: "on"

    action:
      - choose:

          # ğŸŸ¢ KOMFORTNÃ OKNO
          - conditions:
              - condition: template
                value_template: >
                  {% set now = now().strftime('%H:%M:%S') %}
                  {{ (now >= start and now < end)
                     or (end < start and (now >= start or now < end)) }}
            sequence:
              # nastav komfortnÃ­ teplotu
              - service: climate.set_temperature
                target:
                  entity_id: climate.danfoss_etrv0103_2
                data:
                  temperature: "{{ last_comfort }}"
              - service: logbook.log
                data:
                  name: "Rozvrh 2P MÃ¡ma"
                  message: "SpuÅ¡tÄ›n komfortnÃ­ reÅ¾im {{ last_comfort }} Â°C"

          # ğŸŒ¿ MIMO OKNO
          - conditions:
              - condition: template
                value_template: >
                  {% set now = now().strftime('%H:%M:%S') %}
                  {{ not ((now >= start and now < end)
                     or (end < start and (now >= start or now < end))) }}
            sequence:
              - service: climate.set_temperature
                target:
                  entity_id: climate.danfoss_etrv0103_2
                data:
                  temperature: "{{ eco_temp }}"
              - service: logbook.log
                data:
                  name: "Rozvrh 2P MÃ¡ma"
                  message: "PÅ™epnuto na ECO {{ eco_temp }} Â°C"

  # ğŸ’¾ Pamatuj si poslednÃ­ komfortnÃ­ teplotu
  - alias: "Rozvrh 2P MÃ¡ma â€“ uloÅ¾it poslednÃ­ komfort"
    id: schedule_2p_mama_save_last
    mode: queued
    trigger:
      - platform: state
        entity_id: climate.danfoss_etrv0103_2
        attribute: temperature
    condition:
      - condition: template
        value_template: >
          {{ state_attr('climate.danfoss_etrv0103_2', 'temperature') | float(0) >
             states('input_number.eco_temp_default') | float(18) }}
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.2p_mama_last_comfort
        data:
          value: "{{ state_attr('climate.danfoss_etrv0103_2', 'temperature') | float(21) }}"
      - service: logbook.log
        data:
          name: "Rozvrh 2P MÃ¡ma"
          message: "UloÅ¾ena novÃ¡ komfortnÃ­ teplota: {{ state_attr('climate.danfoss_etrv0103_2', 'temperature') }} Â°C"
