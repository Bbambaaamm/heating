# YAML 2024.10
# =====================================================================
# ğŸ§  SOUBOR: /config/heating/schedule/automation/smart/smart_1p_jidelna.yaml
# =====================================================================
# ROZVRH â€“ 1. patro (KuchyÅˆ) â€“ inteligentnÃ­ spouÅ¡tÄ›nÃ­
# ---------------------------------------------------------------------
# CÃ­l:
# SpÃ­nat komfort/ECO jen ve chvÃ­li, kdy dojde ke SKUTEÄŒNÃ‰ zmÄ›nÄ›
# (Äas start/konec, Ãºprava rozvrhu, ruÄnÃ­ zmÄ›na setpointu), a tÃ­m
# udrÅ¾et hlavice klidnÃ© a logy ÄistÃ©.
#
# UvnitÅ™ okna: obnov poslednÃ­ KOMFORT (input_number.1p_jidelna_last_comfort)
#    Mimo okno:   nastav ECO (input_number.eco_temp_default)
# =====================================================================

automation:
  - alias: "Rozvrh 1P KuchyÅˆ â€“ inteligentnÃ­ spouÅ¡tÄ›nÃ­" # NÃ¡zev automatizace v UI
    id: schedule_1p_jidelna_smart # StabilnÃ­ ID (pro odkazy, scÃ©ny, editory)
    mode: restart # PÅ™i novÃ© udÃ¡losti restartuj bÄ›h (vyhne se zÃ¡vodÅ¯m)
    initial_state: true # AktivnÃ­ po restartu HA

    # SpouÅ¡tÄ›Äe â€“ reagujeme pouze na smysluplnÃ© zmÄ›ny (Å¾Ã¡dnÃ© minuty-tiky)
    triggers:
      - trigger: time
        at:
          - input_datetime.1p_jidelna_monday_start
          - input_datetime.1p_jidelna_monday_end
          - input_datetime.1p_jidelna_tuesday_start
          - input_datetime.1p_jidelna_tuesday_end
          - input_datetime.1p_jidelna_wednesday_start
          - input_datetime.1p_jidelna_wednesday_end
          - input_datetime.1p_jidelna_thursday_start
          - input_datetime.1p_jidelna_thursday_end
          - input_datetime.1p_jidelna_friday_start
          - input_datetime.1p_jidelna_friday_end
          - input_datetime.1p_jidelna_saturday_start
          - input_datetime.1p_jidelna_saturday_end
          - input_datetime.1p_jidelna_sunday_start
          - input_datetime.1p_jidelna_sunday_end

      - trigger: state
        entity_id:
          - input_datetime.1p_jidelna_monday_start
          - input_datetime.1p_jidelna_monday_end
          - input_datetime.1p_jidelna_tuesday_start
          - input_datetime.1p_jidelna_tuesday_end
          - input_datetime.1p_jidelna_wednesday_start
          - input_datetime.1p_jidelna_wednesday_end
          - input_datetime.1p_jidelna_thursday_start
          - input_datetime.1p_jidelna_thursday_end
          - input_datetime.1p_jidelna_friday_start
          - input_datetime.1p_jidelna_friday_end
          - input_datetime.1p_jidelna_saturday_start
          - input_datetime.1p_jidelna_saturday_end
          - input_datetime.1p_jidelna_sunday_start
          - input_datetime.1p_jidelna_sunday_end
          - input_boolean.schedule_enable_1p_jidelna

      - trigger: state # ZmÄ›na â€poslednÃ­ komfortâ€œ v HA â†’ aplikuj, pokud jsme v oknÄ›
        entity_id: input_number.1p_jidelna_last_comfort

      - trigger: state # RuÄnÃ­ zmÄ›na setpointu na hlavici â†’ reaguj dle okna
        entity_id: climate.1p_jidelna
        attribute: temperature

    # PromÄ›nnÃ© â€“ naÄtenÃ­ teplot a dynamickÃ½ vÃ½bÄ›r ÄasÅ¯ dle dne
    variables:
      eco_temp: "{{ states('input_number.eco_temp_default') | float(15) }}" # ECO teplota (fallback 15.0)
      last_comfort: "{{ states('input_number.1p_jidelna_last_comfort') | float(22) }}" # PoslednÃ­ komfort (fallback 22)

      start: > # Vyber sprÃ¡vnÃ½ START dle dne v tÃ½dnu
        {% set d = now().weekday() %}  {# 0=Po .. 6=Ne #}
        {% if   d == 0 %} {{ states('input_datetime.1p_jidelna_monday_start') }}
        {% elif d == 1 %} {{ states('input_datetime.1p_jidelna_tuesday_start') }}
        {% elif d == 2 %} {{ states('input_datetime.1p_jidelna_wednesday_start') }}
        {% elif d == 3 %} {{ states('input_datetime.1p_jidelna_thursday_start') }}
        {% elif d == 4 %} {{ states('input_datetime.1p_jidelna_friday_start') }}
        {% elif d == 5 %} {{ states('input_datetime.1p_jidelna_saturday_start') }}
        {% else %}         {{ states('input_datetime.1p_jidelna_sunday_start') }}
        {% endif %}

      end: > # Vyber sprÃ¡vnÃ½ KONEC dle dne v tÃ½dnu
        {% set d = now().weekday() %}
        {% if   d == 0 %} {{ states('input_datetime.1p_jidelna_monday_end') }}
        {% elif d == 1 %} {{ states('input_datetime.1p_jidelna_tuesday_end') }}
        {% elif d == 2 %} {{ states('input_datetime.1p_jidelna_wednesday_end') }}
        {% elif d == 3 %} {{ states('input_datetime.1p_jidelna_thursday_end') }}
        {% elif d == 4 %} {{ states('input_datetime.1p_jidelna_friday_end') }}
        {% elif d == 5 %} {{ states('input_datetime.1p_jidelna_saturday_end') }}
        {% else %}         {{ states('input_datetime.1p_jidelna_sunday_end') }}
        {% endif %}
      now_hms: "{{ now().strftime('%H:%M:%S') }}" # AktuÃ¡lnÃ­ Äas jako HH:MM:SS
      # Jsme uvnitÅ™ okna? BezpeÄnÄ› Å™eÅ¡Ã­ i interval pÅ™es pÅ¯lnoc (start > end)
      in_window: >
        {% set s = start %}
        {% set e = end %}
        {% set n = now_hms %}
        {% if s <= e %}
          {{ s <= n < e }}
        {% else %}
          {{ (n >= s) or (n < e) }}
        {% endif %}

    # Rozvrh musÃ­ bÃ½t zapnutÃ½ (globÃ¡lnÃ­ enable pro zÃ³nu)
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_1p_jidelna
        state: "on"

    # Akce â€“ jednorÃ¡zovÄ› nastav komfort/ECO podle toho, zda jsme â€v oknÄ›â€œ
    action:
      # Debounce: pokud to spustila hlavice, chvilku poÄkej,
      # aby capture stihl uloÅ¾it novÃ½ last_comfort (zabrÃ¡nÃ­ 23â†”22 pendlovÃ¡nÃ­)
      - choose:
          - conditions:
              - condition: template
                value_template: >
                  {{ trigger.platform == 'state'
                     and trigger.entity_id == 'climate.1p_jidelna' }}
            sequence:
              - delay: "00:00:01" # zpoÅ¾dÄ›nÃ­ 1 s pÅ™i triggeru z hlavice

      - choose:
          # UvnitÅ™ okna â†’ nastav poslednÃ­ KOMFORT
          - conditions:
              - condition: template
                value_template: "{{ in_window }}" # True â†’ jsme v oknÄ›
            sequence:
              - action: climate.set_hvac_mode
                target: { entity_id: climate.1p_jidelna } # CÃ­lovÃ¡ hlavice
                data: { hvac_mode: heat } # ReÅ¾im vytÃ¡pÄ›nÃ­
              - condition: template # Guard: nezasahuj, pokud je teplota uÅ¾ stejnÃ¡ (Â±0.1 Â°C)
                value_template: >
                  {{ ((state_attr('climate.1p_jidelna','temperature') | float)
                      - (last_comfort | float)) | abs > 0.1 }}
              - action: climate.set_temperature
                target: { entity_id: climate.1p_jidelna }
                data:
                  temperature: "{{ last_comfort }}" # Nastav uloÅ¾enÃ½ komfort
              - action: logbook.log # ZÃ¡pis do logbooku pro audit
                data:
                  name: "Rozvrh 1P KuchyÅˆ"
                  message: "KomfortnÃ­ reÅ¾im {{ last_comfort }} Â°C (inteligentnÃ­ spuÅ¡tÄ›nÃ­)"
                  entity_id: climate.1p_jidelna

          # Mimo okno â†’ nastav ECO
          - conditions:
              - condition: template
                value_template: "{{ not in_window }}" # False â†’ mimo okno
            sequence:
              - action: climate.set_hvac_mode
                target: { entity_id: climate.1p_jidelna }
                data: { hvac_mode: heat }
              - condition: template # Guard: nezasahuj, pokud je teplota uÅ¾ stejnÃ¡ (Â±0.1 Â°C)
                value_template: >
                  {{ ((state_attr('climate.1p_jidelna','temperature') | float)
                      - (eco_temp | float)) | abs > 0.1 }}
              - action: climate.set_temperature
                target: { entity_id: climate.1p_jidelna }
                data:
                  temperature: "{{ eco_temp }}" # Nastav ECO teplotu
              - action: logbook.log
                data:
                  name: "Rozvrh 1P KuchyÅˆ"
                  message: "ECO {{ eco_temp }} Â°C (inteligentnÃ­ spuÅ¡tÄ›nÃ­)"
                  entity_id: climate.1p_jidelna
