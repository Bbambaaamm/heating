# YAML 2024.10
# =====================================================================
# üß† SOUBOR: /config/heating/schedule/automation/schedule_automation_prizemi_michal.yaml
# =====================================================================
# ROZVRH ‚Äì P≈ô√≠zem√≠ (Michal) ‚Äì inteligentn√≠ spou≈°tƒõn√≠
# ---------------------------------------------------------------------
# C√≠l:
# Sp√≠nat komfort/ECO jen ve chv√≠li, kdy dojde ke SKUTEƒåN√â zmƒõnƒõ
# (ƒças start/konec, √∫prava rozvrhu, ruƒçn√≠ zmƒõna setpointu), a t√≠m
# udr≈æet hlavice klidn√© a logy ƒçist√©.
#
# Uvnit≈ô okna: obnov posledn√≠ KOMFORT (input_number.prizemi_michal_last_comfort)
#    Mimo okno:   nastav ECO (input_number.eco_temp_default)
# =====================================================================

automation:
  - alias: "Rozvrh P≈ô√≠zem√≠ ‚Äì inteligentn√≠ spou≈°tƒõn√≠" # N√°zev automatizace v UI
    id: schedule_prizemi_michal_smart # Stabiln√≠ ID (pro odkazy, sc√©ny, editory)
    mode: restart # P≈ôi nov√© ud√°losti restartuj bƒõh (vyhne se z√°vod≈Øm)
    initial_state: true # Aktivn√≠ po restartu HA

    # Spou≈°tƒõƒçe ‚Äì reagujeme pouze na smyslupln√© zmƒõny (≈æ√°dn√© minuty-tiky)
    triggers:
      - trigger: time
        at:
          - input_datetime.prizemi_michal_monday_start
          - input_datetime.prizemi_michal_monday_end
          - input_datetime.prizemi_michal_tuesday_start
          - input_datetime.prizemi_michal_tuesday_end
          - input_datetime.prizemi_michal_wednesday_start
          - input_datetime.prizemi_michal_wednesday_end
          - input_datetime.prizemi_michal_thursday_start
          - input_datetime.prizemi_michal_thursday_end
          - input_datetime.prizemi_michal_friday_start
          - input_datetime.prizemi_michal_friday_end
          - input_datetime.prizemi_michal_saturday_start
          - input_datetime.prizemi_michal_saturday_end
          - input_datetime.prizemi_michal_sunday_start
          - input_datetime.prizemi_michal_sunday_end

      - trigger: state
        entity_id:
          - input_datetime.prizemi_michal_monday_start
          - input_datetime.prizemi_michal_monday_end
          - input_datetime.prizemi_michal_tuesday_start
          - input_datetime.prizemi_michal_tuesday_end
          - input_datetime.prizemi_michal_wednesday_start
          - input_datetime.prizemi_michal_wednesday_end
          - input_datetime.prizemi_michal_thursday_start
          - input_datetime.prizemi_michal_thursday_end
          - input_datetime.prizemi_michal_friday_start
          - input_datetime.prizemi_michal_friday_end
          - input_datetime.prizemi_michal_saturday_start
          - input_datetime.prizemi_michal_saturday_end
          - input_datetime.prizemi_michal_sunday_start
          - input_datetime.prizemi_michal_sunday_end
          - input_boolean.schedule_enable_prizemi_michal

      - trigger: state
        entity_id: input_number.prizemi_michal_last_comfort

      - trigger: state
        entity_id: climate.prizemi_michal
        attribute: temperature

    # Promƒõnn√© ‚Äì naƒçten√≠ teplot a dynamick√Ω v√Ωbƒõr ƒças≈Ø dle dne
    variables:
      eco_temp: "{{ states('input_number.eco_temp_default') | float(15) }}" # ECO teplota (fallback 18.0)
      last_comfort: "{{ states('input_number.prizemi_michal_last_comfort') | float(22) }}" # Posledn√≠ komfort (fallback 22)

      start: > # Vyber spr√°vn√Ω START dle dne v t√Ωdnu
        {% set d = now().weekday() %}  {# 0=Po .. 6=Ne #}
        {% if   d == 0 %} {{ states('input_datetime.prizemi_michal_monday_start') }}
        {% elif d == 1 %} {{ states('input_datetime.prizemi_michal_tuesday_start') }}
        {% elif d == 2 %} {{ states('input_datetime.prizemi_michal_wednesday_start') }}
        {% elif d == 3 %} {{ states('input_datetime.prizemi_michal_thursday_start') }}
        {% elif d == 4 %} {{ states('input_datetime.prizemi_michal_friday_start') }}
        {% elif d == 5 %} {{ states('input_datetime.prizemi_michal_saturday_start') }}
        {% else %}         {{ states('input_datetime.prizemi_michal_sunday_start') }}
        {% endif %}

      end: > # Vyber spr√°vn√Ω KONEC dle dne v t√Ωdnu
        {% set d = now().weekday() %}
        {% if   d == 0 %} {{ states('input_datetime.prizemi_michal_monday_end') }}
        {% elif d == 1 %} {{ states('input_datetime.prizemi_michal_tuesday_end') }}
        {% elif d == 2 %} {{ states('input_datetime.prizemi_michal_wednesday_end') }}
        {% elif d == 3 %} {{ states('input_datetime.prizemi_michal_thursday_end') }}
        {% elif d == 4 %} {{ states('input_datetime.prizemi_michal_friday_end') }}
        {% elif d == 5 %} {{ states('input_datetime.prizemi_michal_saturday_end') }}
        {% else %}         {{ states('input_datetime.prizemi_michal_sunday_end') }}
        {% endif %}
      now_hms: "{{ now().strftime('%H:%M:%S') }}" # Aktu√°ln√≠ ƒças jako HH:MM:SS
      # Jsme uvnit≈ô okna? Bezpeƒçnƒõ ≈ôe≈°√≠ i interval p≈ôes p≈Ølnoc (start > end)
      in_window: >
        {% set s = start %}
        {% set e = end %}
        {% set n = now_hms %}
        {% if s <= e %}
          {{ s <= n < e }}
        {% else %}
          {{ (n >= s) or (n < e) }}
        {% endif %}

    # Rozvrh mus√≠ b√Ωt zapnut√Ω (glob√°ln√≠ enable pro z√≥nu)
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_prizemi_michal
        state: "on"

    # Akce ‚Äì jednor√°zovƒõ nastav komfort/ECO podle toho, zda jsme ‚Äûv oknƒõ‚Äú
    actions:
      # Debounce: pokud to spustila hlavice, chvilku poƒçkej,
      # aby capture stihl ulo≈æit nov√Ω last_comfort (zabr√°n√≠ 23‚Üî22 pendlov√°n√≠)
      - choose:
          - conditions:
              - condition: template
                value_template: >
                  {{ trigger.trigger == 'state'
                     and trigger.entity_id == 'climate.prizemi_michal' }}
            sequence:
              - delay: "00:00:01" # zpo≈ædƒõn√≠ 1 s p≈ôi triggeru z hlavice

      - choose:
          # Uvnit≈ô okna ‚Üí nastav posledn√≠ KOMFORT
          - conditions:
              - condition: template
                value_template: "{{ in_window }}" # True ‚Üí jsme v oknƒõ
            sequence:
              - action: climate.set_hvac_mode
                target: { entity_id: climate.prizemi_michal } # C√≠lov√° hlavice
                data: { hvac_mode: heat } # Re≈æim vyt√°pƒõn√≠
              - condition: template # Guard: nezasahuj, pokud je teplota u≈æ stejn√° (¬±0.1 ¬∞C)
                value_template: >
                  {{ ((state_attr('climate.prizemi_michal','temperature') | float)
                      - (last_comfort | float)) | abs > 0.1 }}
              - action: climate.set_temperature
                target: { entity_id: climate.prizemi_michal }
                data:
                  temperature: "{{ last_comfort }}" # Nastav ulo≈æen√Ω komfort
              - action: logbook.log # Z√°pis do logbooku pro audit
                data:
                  name: "Rozvrh P≈ô√≠zem√≠"
                  message: "Komfortn√≠ re≈æim {{ last_comfort }} ¬∞C (inteligentn√≠ spu≈°tƒõn√≠)"
                  entity_id: climate.prizemi_michal

          # Mimo okno ‚Üí nastav ECO
          - conditions:
              - condition: template
                value_template: "{{ not in_window }}" # False ‚Üí mimo okno
            sequence:
              - action: climate.set_hvac_mode
                target: { entity_id: climate.prizemi_michal }
                data: { hvac_mode: heat }
              - condition: template # Guard: nezasahuj, pokud je teplota u≈æ stejn√° (¬±0.1 ¬∞C)
                value_template: >
                  {{ ((state_attr('climate.prizemi_michal','temperature') | float)
                      - (eco_temp | float)) | abs > 0.1 }}
              - action: climate.set_temperature
                target: { entity_id: climate.prizemi_michal }
                data:
                  temperature: "{{ eco_temp }}" # Nastav ECO teplotu
              - action: logbook.log
                data:
                  name: "Rozvrh P≈ô√≠zem√≠"
                  message: "ECO {{ eco_temp }} ¬∞C (inteligentn√≠ spu≈°tƒõn√≠)"
                  entity_id: climate.prizemi_michal
