# =====================================================================
# ğŸ•’ ROZVRH â€“ PÅ™Ã­zemÃ­ (Michal) â€“ inteligentnÃ­ spouÅ¡tÄ›nÃ­
# - SpÃ­nÃ¡ POUZE pÅ™i zmÄ›nÄ› (Äas start/konec, zmÄ›na rozvrhu, ruÄnÃ­ zmÄ›na setpointu)
# - UvnitÅ™ okna â†’ nastavÃ­ poslednÃ­ komfortnÃ­ teplotu (input_number.prizemi_michal_last_comfort)
# - Mimo okno   â†’ nastavÃ­ ECO teplotu (input_number.eco_temp_default)
# - NEposÃ­lÃ¡ nic kaÅ¾dou minutu â†’ klidnÃ© hlavice, ÄistÃ© logy
# =====================================================================

automation:
  - alias: "Rozvrh PÅ™Ã­zemÃ­ â€“ inteligentnÃ­ spouÅ¡tÄ›nÃ­"
    id: schedule_prizemi_michal_smart
    mode: restart
    initial_state: true

    # ğŸ”” SpouÅ¡tÄ›Äe: jen skuteÄnÃ© zmÄ›ny (Å¾Ã¡dnÃ½ time_pattern kaÅ¾dou minutu)
    trigger:
      # â–¶ï¸ Nastal Äas startu nebo konce (funguje i pro time-only input_datetime)
      - platform: time
        at:
          - input_datetime.prizemi_michal_weekday_start
          - input_datetime.prizemi_michal_weekday_end
          - input_datetime.prizemi_michal_weekend_start
          - input_datetime.prizemi_michal_weekend_end

      # â–¶ï¸ NÄ›kdo upravil Äasy / povolenÃ­ rozvrhu
      - platform: state
        entity_id:
          - input_datetime.prizemi_michal_weekday_start
          - input_datetime.prizemi_michal_weekday_end
          - input_datetime.prizemi_michal_weekend_start
          - input_datetime.prizemi_michal_weekend_end
          - input_boolean.schedule_enable_prizemi_michal

      # â–¶ï¸ UÅ¾ivatel zmÄ›nil setpoint na hlavici (abychom umÄ›li hned zareagovat, pokud jsme â€uvnitÅ™ oknaâ€œ)
      - platform: state
        entity_id: climate.danfoss_etrv0103
        attribute: temperature

    # ğŸ“¦ PomocnÃ© promÄ›nnÃ© â€“ vyber sprÃ¡vnÃ© Äasy podle dne + naÄti ECO/poslednÃ­ KOMFORT
    variables:
      eco_temp: "{{ states('input_number.eco_temp_default') | float(18) }}"
      last_comfort: "{{ states('input_number.prizemi_michal_last_comfort') | float(21.5) }}"

      start: >
        {% if now().isoweekday() in [1,2,3,4,5] %}
          {{ states('input_datetime.prizemi_michal_weekday_start') }}
        {% else %}
          {{ states('input_datetime.prizemi_michal_weekend_start') }}
        {% endif %}
      end: >
        {% if now().isoweekday() in [1,2,3,4,5] %}
          {{ states('input_datetime.prizemi_michal_weekday_end') }}
        {% else %}
          {{ states('input_datetime.prizemi_michal_weekend_end') }}
        {% endif %}
      now_hms: "{{ now().strftime('%H:%M:%S') }}"

      # ğŸ§® Jsme uvnitÅ™ okna? (Å™eÅ¡Ã­ i pÅ™es pÅ¯lnoc)
      in_window: >
        {% set s = start %}
        {% set e = end %}
        {% set n = now_hms %}
        {% if s <= e %}
          {{ s <= n < e }}
        {% else %}
          {{ (n >= s) or (n < e) }}
        {% endif %}

    # âœ… Rozvrh tÃ©to zÃ³ny musÃ­ bÃ½t povolen
    condition:
      - condition: state
        entity_id: input_boolean.schedule_enable_prizemi_michal
        state: "on"

    # â–¶ï¸ JednorÃ¡zovÃ¡ akce podle toho, kde prÃ¡vÄ› jsme vzhledem k oknu
    action:
      - choose:
          # ğŸŸ¢ UvnitÅ™ okna â†’ komfortnÃ­ teplota
          - conditions:
              - condition: template
                value_template: "{{ in_window }}"
            sequence:
              - service: climate.set_hvac_mode
                target: { entity_id: climate.danfoss_etrv0103 }
                data: { hvac_mode: heat }
              - service: climate.set_temperature
                target: { entity_id: climate.danfoss_etrv0103 }
                data:
                  temperature: "{{ last_comfort }}"
              - service: logbook.log
                data:
                  name: "Rozvrh PÅ™Ã­zemÃ­"
                  message: "KomfortnÃ­ reÅ¾im {{ last_comfort }} Â°C (inteligentnÃ­ spuÅ¡tÄ›nÃ­)"
                  entity_id: climate.danfoss_etrv0103

          # ğŸŒ¿ Mimo okno â†’ ECO teplota
          - conditions:
              - condition: template
                value_template: "{{ not in_window }}"
            sequence:
              - service: climate.set_hvac_mode
                target: { entity_id: climate.danfoss_etrv0103 }
                data: { hvac_mode: heat }
              - service: climate.set_temperature
                target: { entity_id: climate.danfoss_etrv0103 }
                data:
                  temperature: "{{ eco_temp }}"
              - service: logbook.log
                data:
                  name: "Rozvrh PÅ™Ã­zemÃ­"
                  message: "ECO {{ eco_temp }} Â°C (inteligentnÃ­ spuÅ¡tÄ›nÃ­)"
                  entity_id: climate.danfoss_etrv0103
