# YAML 2024.10
# =====================================================================
# ðŸ§  SOUBOR: /config/heating/schedule/preferences/zone_1p_jidelna_capture_comfort.yaml
# =====================================================================
# ðŸ§² 1. patro â€“ JÃ­delna: zachytÃ¡vÃ¡nÃ­ poslednÃ­ KOMFORTNÃ teploty
# =====================================================================

automation:
  - alias: "Zachytni poslednÃ­ komfort â€“ 1. patro JÃ­delna"
    id: capture_last_comfort_1p_jidelna
    mode: restart
    initial_state: true

    triggers:
      - trigger: state
        entity_id: climate.1p_jidelna
        attribute: temperature

    variables:
      new_set: "{{ state_attr('climate.1p_jidelna', 'temperature') | float(0) }}"
      eco: "{{ states('input_number.eco_temp_default') | float(18) }}"

    # Guardy (sprÃ¡vnÃ© umÃ­stÄ›nÃ­ pro 2024.10)
    conditions:
      # UklÃ¡dat jen komfort (nad ECO + 0.2 Â°C)
      - condition: template
        value_template: "{{ new_set >= (eco + 0.2) }}"
      # UklÃ¡dat jen pÅ™i skuteÄnÃ© zmÄ›nÄ› (> 0.1 Â°C)
      - condition: template
        value_template: >
          {{ (states('input_number.1p_jidelna_last_comfort') | float(0) - new_set) | abs > 0.1 }}
      - condition: state
        entity_id: binary_sensor.kotel_boost_active
        state: "off"

    actions:
      - action: input_number.set_value
        target:
          entity_id: input_number.1p_jidelna_last_comfort
        data:
          value: "{{ new_set }}"

      - action: logbook.log
        data:
          name: "1. patro â€“ JÃ­delna"
          message: "UloÅ¾ena komfortnÃ­ teplota: {{ new_set }} Â°C"
          entity_id: climate.1p_jidelna
