# =====================================================================
# PÅ™Ã­zemÃ­ Michal: zachytÃ¡vÃ¡nÃ­ poslednÃ­ KOMFORTNÃ teploty
# ---------------------------------------------------------------------
# ğŸ” CÃ­l:
# Tato automatizace sleduje, kdy Michal ruÄnÄ› (nebo pÅ™es rozvrh)
# zmÄ›nÃ­ teplotu na hlavici. Pokud novÃ¡ hodnota odpovÃ­dÃ¡ komfortnÃ­mu
# reÅ¾imu (tj. je vyÅ¡Å¡Ã­ neÅ¾ ECO teplota), uloÅ¾Ã­ se do helperu
# `input_number.prizemi_michal_last_comfort`.
#
# â• DÃ­ky tomu se pÅ™i nÃ¡vratu z ECO mÃ³du (napÅ™. po odchodu nebo v noci)
# mÅ¯Å¾e automaticky obnovit prÃ¡vÄ› ta poslednÃ­ komfortnÃ­ teplota,
# kterou uÅ¾ivatel naposledy pouÅ¾il.
# =====================================================================

automation:
  - alias: "Zachytni poslednÃ­ komfort â€“ PÅ™Ã­zemÃ­ Michal" # NÃ¡zev automatizace
    id: prizemi_michal_capture_last_comfort # JednoznaÄnÃ© ID pro systÃ©m
    mode: restart # Restartne bÄ›h pÅ™i novÃ© zmÄ›nÄ›
    initial_state: true # Automatizace je aktivnÃ­ po restartu HA

    # SpouÅ¡tÄ›Ä: reaguje na zmÄ›nu Å¾Ã¡danÃ© teploty na hlavici
    triggers:
      - trigger: state # Sleduje zmÄ›nu stavu/atributu
        entity_id: climate.prizemi_michal # CÃ­lovÃ¡ hlavice (Michal â€“ pÅ™Ã­zemÃ­)
        attribute: temperature # Sledujeme atribut â€temperatureâ€œ (Å¾Ã¡danÃ¡ teplota)

    # PromÄ›nnÃ© pro vÃ½poÄet
    variables:
      new_set: "{{ state_attr('climate.prizemi_michal', 'temperature') | float(0) }}" # NovÄ› nastavenÃ¡ teplota
      eco: "{{ states('input_number.eco_temp_default') | float(18) }}" # ECO teplota z globÃ¡lnÃ­ho helperu

    # PodmÃ­nka: uklÃ¡dÃ¡ se pouze komfortnÃ­ teplota (vÄ›tÅ¡Ã­ neÅ¾ ECO + 0.2 Â°C)
    condition:
      - condition: template
        value_template: "{{ new_set >= (eco + 0.2) }}" # Hystereze 0.2 Â°C brÃ¡nÃ­ faleÅ¡nÃ½m pÅ™echodÅ¯m

    # Akce: uloÅ¾Ã­ poslednÃ­ komfortnÃ­ teplotu do helperu
    actions:
      # âœ… Nejprve ovÄ›Å™Ã­, Å¾e se komfortnÃ­ teplota skuteÄnÄ› zmÄ›nila (Â±0.1 Â°C)
      - condition: template
        value_template: >
          {{ ((states('input_number.prizemi_michal_last_comfort') | float) - (new_set | float)) | abs > 0.1 }}

      - action: input_number.set_value # ZÃ¡pis hodnoty do input_number (uloÅ¾enÃ­ novÃ© komfortnÃ­ teploty)
        target:
          entity_id: input_number.prizemi_michal_last_comfort # CÃ­lovÃ½ helper (komfortnÃ­ teplota)
        data:
          value: "{{ new_set }}" # Hodnota = aktuÃ¡lnÄ› nastavenÃ¡ teplota

      # ğŸª¶ LogovÃ¡nÃ­ pro pÅ™ehled (uloÅ¾enÃ­ novÃ© komfortnÃ­ teploty do Logbooku)
      - action: logbook.log
        data:
          name: "PÅ™Ã­zemÃ­ Michal" # NÃ¡zev v logu
          message: "UloÅ¾ena komfortnÃ­ teplota: {{ new_set }} Â°C" # ZprÃ¡va do Logbooku
          entity_id: climate.prizemi_michal # K jakÃ© entitÄ› se vztahuje
