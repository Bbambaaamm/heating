# YAML 2024.10
# =====================================================================
# ðŸ§  SOUBOR: /config/heating/schedule/schedule_automations.yaml
# =====================================================================
# ROZVRH â€“ zÃ³ny: PÅ™Ã­zemÃ­ (Michal), 1. patro (KuchyÅˆ), 2. patro (MÃ¡ma)
# ---------------------------------------------------------------------
# CÃ­l:
# Nastavit teplotu hlavic podle rozvrhovÃ½ch entit schedule.*.
# SpouÅ¡tÃ­ se pÅ™i skuteÄnÃ© zmÄ›nÄ› (schedule on/off) a po startu HA.
#
# UvnitÅ™ okna rozvrhu: komfortnÃ­ teplota (sensor.*_comfort_temp)
# Mimo okno rozvrhu:   ECO teplota (sensor.*_eco_temp)
# Pozn.: senzory comfort/eco uÅ¾ obsahujÃ­ pÅ™Ã­padnÃ© oÅ™ezy, proto zde
# neÅ™eÅ¡Ã­me logiku komfortu/ECO â€“ pouze aplikaci teplot.
# =====================================================================

automation:
  # =====================================================================
  # â”€â”€ PÅ™Ã­zemÃ­ â€“ Michal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # =====================================================================
  - id: schedule_prizemi_michal_follow
    alias: "Rozvrh: PÅ™Ã­zemÃ­ Michal â†’ nastav teplotu"
    mode: restart # pÅ™i novÃ© zmÄ›nÄ› rozvrhu pÅ™epiÅ¡ pÅ™edchozÃ­ bÄ›h
    triggers:
      - trigger: state # reaguje na zapnutÃ­/vypnutÃ­ rozvrhu
        entity_id: schedule.zona_prizemi_michal_komfort
      - trigger: homeassistant # po startu HA znovu nastav teplotu
        event: start
    actions:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.platform == 'homeassistant' }}"
            sequence:
              - delay: "00:00:03" # poÄkej 3 s po startu HA (na naÄtenÃ­ entit)

      - variables:
          is_on: "{{ is_state('schedule.zona_prizemi_michal_komfort','on') }}" # stav rozvrhu: komfort ano/ne
          comfort: "{{ states('sensor.zona_prizemi_michal_comfort_temp') | float(22) }}" # komfortnÃ­ teplota
          eco: "{{ states('sensor.zona_prizemi_michal_eco_temp') | float(19) }}" # ECO teplota
          current: "{{ state_attr('climate.prizemi_michal','temperature') | float(0) }}" # aktuÃ¡lnÃ­ nastavenÃ¡ teplota
          hvac: "{{ states('climate.prizemi_michal') | lower }}" # aktuÃ¡lnÃ­ reÅ¾im (heat/off)
          target_temp: "{{ comfort if is_on else eco }}" # cÃ­lovÃ¡ teplota podle rozvrhu

      - condition: template
        value_template: "{{ target_temp | float(0) > 0 }}" # kontrola, Å¾e cÃ­lovÃ¡ teplota nenÃ­ null/0

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ hvac != 'heat' }}" # pokud nenÃ­ zapnut reÅ¾im topenÃ­
            sequence:
              - action: climate.set_hvac_mode
                target: { entity_id: climate.prizemi_michal }
                data: { hvac_mode: heat } # pÅ™epni hlavici do reÅ¾imu topenÃ­

      - condition: template
        value_template: "{{ (current - target_temp) | abs > 0.1 }}" # posÃ­lej jen, pokud se teplota opravdu liÅ¡Ã­

      - action: climate.set_temperature
        target: { entity_id: climate.prizemi_michal } # cÃ­lovÃ¡ hlavice (Michal â€“ pÅ™Ã­zemÃ­)
        data: { temperature: "{{ target_temp }}" } # nastav cÃ­lovou teplotu

      - action: logbook.log
        data:
          name: "Rozvrh â€“ PÅ™Ã­zemÃ­ Michal" # ÄitelnÃ½ nÃ¡zev v denÃ­ku
          message: >
            ZmÄ›na podle rozvrhu ({{ 'komfort' if is_on else 'ECO' }}) â†’
            {{ target_temp }} Â°C
            [zdroj: {{ 'schedule on/off' if trigger.platform == 'state' else 'HA start' }}]
          entity_id: climate.prizemi_michal # svÃ¡Å¾e zÃ¡znam s hlavicÃ­

  # =====================================================================
  # â”€â”€ 1. patro â€“ KuchyÅˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # =====================================================================

  - id: schedule_1p_jidelna_follow
    alias: "Rozvrh: 1. patro KuchyÅˆ â†’ nastav teplotu"
    mode: restart
    triggers:
      - trigger: state
        entity_id: schedule.zona_1p_jidelna_komfort
      - trigger: homeassistant
        event: start
    actions:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.platform == 'homeassistant' }}"
            sequence:
              - delay: "00:00:03" # 3 s po startu HA

      - variables:
          is_on: "{{ is_state('schedule.zona_1p_jidelna_komfort','on') }}" # rozvrh zapnut?
          comfort: "{{ states('sensor.zona_1p_jidelna_comfort_temp') | float(22) }}" # komfortnÃ­ teplota
          eco: "{{ states('sensor.zona_1p_jidelna_eco_temp') | float(19) }}" # ECO teplota
          current: "{{ state_attr('climate.1p_jidelna','temperature') | float(0) }}" # aktuÃ¡lnÃ­ teplota
          hvac: "{{ states('climate.1p_jidelna') | lower }}" # reÅ¾im heat/off
          target_temp: "{{ comfort if is_on else eco }}" # cÃ­lovÃ¡ teplota

      - condition: template
        value_template: "{{ target_temp | float(0) > 0 }}" # validnÃ­ hodnota teploty?

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ hvac != 'heat' }}" # pÅ™epni na topenÃ­, pokud nenÃ­ aktivnÃ­
            sequence:
              - action: climate.set_hvac_mode
                target: { entity_id: climate.1p_jidelna }
                data: { hvac_mode: heat }

      - condition: template
        value_template: "{{ (current - target_temp) | abs > 0.1 }}" # aktualizuj jen, pokud se zmÄ›nila hodnota

      - action: climate.set_temperature
        target: { entity_id: climate.1p_jidelna } # cÃ­lovÃ¡ hlavice (1. patro â€“ kuchyÅˆ)
        data: { temperature: "{{ target_temp }}" }

      - action: logbook.log
        data:
          name: "Rozvrh â€“ 1. patro KuchyÅˆ"
          message: >
            ZmÄ›na podle rozvrhu ({{ 'komfort' if is_on else 'ECO' }}) â†’
            {{ target_temp }} Â°C
            [zdroj: {{ 'schedule on/off' if trigger.platform == 'state' else 'HA start' }}]
          entity_id: climate.1p_jidelna

  # =====================================================================
  # â”€â”€ 2. patro â€“ MÃ¡ma â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # =====================================================================

  - id: schedule_2p_mama_follow
    alias: "Rozvrh: 2. patro MÃ¡ma â†’ nastav teplotu"
    mode: restart
    triggers:
      - trigger: state
        entity_id: schedule.zona_2p_mama_komfort
      - trigger: homeassistant
        event: start
    action:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.platform == 'homeassistant' }}"
            sequence:
              - delay: "00:00:03" # 3 s po startu HA

      - variables:
          is_on: "{{ is_state('schedule.zona_2p_mama_komfort','on') }}" # stav rozvrhu (komfort/ECO)
          comfort: "{{ states('sensor.zona_2p_mama_comfort_temp') | float(22) }}" # komfortnÃ­ teplota
          eco: "{{ states('sensor.zona_2p_mama_eco_temp') | float(19) }}" # ECO teplota
          current: "{{ state_attr('climate.2p_mama','temperature') | float(0) }}" # aktuÃ¡lnÃ­ setpoint
          hvac: "{{ states('climate.2p_mama') | lower }}" # aktuÃ¡lnÃ­ reÅ¾im hlavice
          target_temp: "{{ comfort if is_on else eco }}" # cÃ­lovÃ¡ teplota podle rozvrhu

      - condition: template
        value_template: "{{ target_temp | float(0) > 0 }}" # kontrola, Å¾e je hodnota platnÃ¡

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ hvac != 'heat' }}" # nastav reÅ¾im heat, pokud nenÃ­ aktivnÃ­
            sequence:
              - action: climate.set_hvac_mode
                target: { entity_id: climate.2p_mama }
                data: { hvac_mode: heat }

      - condition: template
        value_template: "{{ (current - target_temp) | abs > 0.1 }}" # posÃ­lej jen, kdyÅ¾ se teplota liÅ¡Ã­

      - action: climate.set_temperature
        target: { entity_id: climate.2p_mama } # cÃ­lovÃ¡ hlavice (2. patro â€“ mÃ¡ma)
        data: { temperature: "{{ target_temp }}" }

      - action: logbook.log
        data:
          name: "Rozvrh â€“ 2. patro MÃ¡ma"
          message: >
            ZmÄ›na podle rozvrhu ({{ 'komfort' if is_on else 'ECO' }}) â†’
            {{ target_temp }} Â°C
            [zdroj: {{ 'schedule on/off' if trigger.platform == 'state' else 'HA start' }}]
          entity_id: climate.2p_mama
