# YAML 2024.10
# =====================================================================
# ðŸ§  SOUBOR: /config/heating/control/External senzors/zone_sklep_michal_external_sensor.yaml
# =====================================================================
# ðŸŒ¡ï¸ EXTERNÃ SENZOR â€“ sklep Michal
# ---------------------------------------------------------------------
# ÃšÄel:
# - PÅ™edÃ¡vÃ¡ aktuÃ¡lnÃ­ teplotu z externÃ­ho senzoru (mi_air_purifier_2h_teplota)
#   do hlavice Danfoss (entita number.sklep_michal_senzor_externi_teploty).
# - VyÅ¾aduje, aby v hlavici bylo aktivnÃ­:
#   "UpÅ™ednostnit externÃ­ teplotnÃ­ senzor" = ON
#
# Odolnosti:
# - ZnovuposlÃ¡nÃ­ po startu Home Assistantu (zajiÅ¡Å¥uje obnovu hodnoty po restartu)
# - PeriodickÃ½ refresh kaÅ¾dÃ½ch 10 minut (pojistka pro pÅ™Ã­pad, Å¾e se trigger neaktivuje)
# - Ochrana proti chybnÃ½m / nedefinovanÃ½m hodnotÃ¡m (unknown, NaN, mimo rozsah)
# =====================================================================

automation:
  - alias: "Danfoss sklep Michal â€“ pÅ™eposlat teplotu z externÃ­ho senzoru" # NÃ¡zev automatizace viditelnÃ½ v UI
    id: danfoss_sklep_michal_external_temp_forward # JednoznaÄnÃ© ID automatizace pro konfiguraci a sledovÃ¡nÃ­
    mode: queued # ZajistÃ­ sekvenÄnÃ­ zpracovÃ¡nÃ­ fronty (pÅ™edchÃ¡zÃ­ pÅ™eruÅ¡enÃ­)

    triggers:
      # ðŸ”¹ SpouÅ¡tÄ›Ä 1: pÅ™i zmÄ›nÄ› hodnoty externÃ­ho senzoru
      - trigger: state
        entity_id: sensor.mi_air_purifier_2h_teplota

      # ðŸ”¹ SpouÅ¡tÄ›Ä 2: po startu Home Assistantu â€“ zajiÅ¡Å¥uje, Å¾e po restartu
      #      se hlavici znovu odeÅ¡le aktuÃ¡lnÃ­ teplota (hodnota se totiÅ¾ neuchovÃ¡vÃ¡)
      - trigger: homeassistant
        event: start

      # ðŸ”¹ SpouÅ¡tÄ›Ä 3: pojistka â€“ kaÅ¾dÃ½ch 10 minut poÅ¡le hodnotu znovu,
      #      i kdyÅ¾ se teplota nezmÄ›nila (napÅ™. u stabilnÃ­ch hodnot)
      - trigger: time_pattern
        minutes: "/10"

    actions:
      # =================================================================
      # ðŸ§© PÅ˜ÃPRAVA PROMÄšNNÃCH
      # - raw  = textovÃ¡ hodnota senzoru (napÅ™. "21.7")
      # - temp = pÅ™evedenÃ¡ ÄÃ­selnÃ¡ hodnota teploty (float)
      # =================================================================
      - variables:
          raw: "{{ states('sensor.mi_air_purifier_2h_teplota') }}"
          temp: "{{ raw | float(none) }}"

      # =================================================================
      # ðŸ§© PODMÃNÄšNÃ‰ ZPRACOVÃNÃ
      # - OvÄ›Å™Ã­, Å¾e hodnota je definovanÃ¡ (nenÃ­ None)
      # - Je v reÃ¡lnÃ©m rozsahu (-40 aÅ¾ +60 Â°C)
      # - Pokud ano â†’ poÅ¡le hodnotu hlavici
      # =================================================================
      - choose:
          - conditions: >
              {{ temp is not none and -40 < temp < 60 }}
            sequence:
              # ðŸ”¸ OdeslÃ¡nÃ­ teploty do entity hlavice Danfoss
              - action: number.set_value
                target:
                  entity_id: number.sklep_michal_senzor_externi_teploty
                data:
                  value: "{{ temp }}"
        default: [] # Pokud hodnota nenÃ­ platnÃ¡, neprovede se nic (Å¾Ã¡dnÃ¡ akce)
