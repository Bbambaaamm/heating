# YAML 2024.10
# =====================================================================
# üß† /config/heating/control/mode_boost.yaml ‚Äì BOOST LOGIKA (only)
# =====================================================================

template:
  # ‚îÄ‚îÄ BOOST aktivn√≠? (re≈æim Boost NEBO tlaƒç√≠tko NEBO do-ƒçasu) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  - binary_sensor:
      - name: "kotel_boost_active"
        unique_id: kotel_boost_active
        device_class: heat

        # ‚úÖ Senzor je dostupn√Ω a≈æ kdy≈æ jsou dostupn√© v≈°echny vstupy
        availability: >-
          {{ states('input_select.topny_rezim') not in ['unknown','unavailable','']
             and states('input_boolean.boost_now') not in ['unknown','unavailable','']
             and states('input_datetime.boost_until') not in ['unknown','unavailable',''] }}

        # ‚úÖ ON kdy≈æ: re≈æim Boost, tlaƒç√≠tko ON, nebo boost_until v budoucnu
        state: >-
          {% set mode = states('input_select.topny_rezim') %}
          {% set btn  = is_state('input_boolean.boost_now','on') %}
          {% set uts  = as_timestamp(states('input_datetime.boost_until'), default=0) %}
          {{ mode == 'Boost' or btn or (now().timestamp() < uts) }}

        attributes:
          until: "{{ states('input_datetime.boost_until') }}"
          remaining_min: >-
            {% set uts = as_timestamp(states('input_datetime.boost_until'), default=0) %}
            {% set rem = (uts - now().timestamp()) / 60 %}
            {{ rem|round(0) if rem > 0 else 0 }}


# =====================================================================
# ü§ñ AUTOMATIZACE PRO BOOST
# =====================================================================
automation:

  # ‚ñ∂Ô∏è Start Boostu ‚Äì z re≈æimu nebo tlaƒç√≠tkem ‚Üí nastav boost_until
  - id: heating_boost_start
    alias: "Topen√≠: start Boostu (nastav boost_until)"
    mode: restart
    triggers:
      - trigger: state
        entity_id: input_select.topny_rezim
        to: "Boost"
      - trigger: state
        entity_id: input_boolean.boost_now
        to: "on"
    actions:
      - variables:
          minutes: "{{ states('input_number.boost_minutes') | int(60) }}"
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.boost_until
        data:
          datetime: "{{ (now() + timedelta(minutes=minutes)).isoformat() }}"

  # ‚ö° Boost ON ‚Üí nastav komfortn√≠ setpointy (posledn√≠ komfort + offset)
  - id: heating_boost_apply_comfort_on
    alias: "Boost: p≈ôi startu nastav komfort do z√≥n"
    mode: restart

    triggers:
      - trigger: state
        entity_id: binary_sensor.kotel_boost_active
        to: "on"

    conditions:
      - condition: state
        entity_id: input_boolean.topny_system_enable
        state: "on"
      - condition: state
        entity_id: binary_sensor.kotel_mode_off_block
        state: "off"

    variables:
      boost_offset: "{{ states('input_number.boost_comfort_offset_c')|float(0) }}"
      # zde definujeme z√≥ny + jejich "last comfort" helper
      zones: >
        {{ [
          dict(name='P≈ô√≠zem√≠ ‚Äì Michal', climate='climate.prizemi_michal', last='input_number.prizemi_michal_last_comfort'),
          dict(name='1. patro ‚Äì Kuchy≈à', climate='climate.1p_jidelna',    last='input_number.1p_jidelna_last_comfort'),
          dict(name='2. patro ‚Äì M√°ma',  climate='climate.2p_mama',        last='input_number.2p_mama_last_comfort')
        ] }}

    actions:
      - repeat:
          for_each: "{{ zones }}"
          sequence:
            - variables:
                climate: "{{ repeat.item.climate }}"
                last: "{{ repeat.item.last }}"
                # Z√°klad komfortu: preferuj input_number.*_last_comfort, kdy≈æ by byl unknown ‚Üí vem aktu√°ln√≠ setpoint
                comfort_base: >-
                  {% set v = states(last) %}
                  {% if v not in ['unknown','unavailable',''] %}{{ v|float }}
                  {% else %}{{ state_attr(climate,'temperature')|float(21) }}
                  {% endif %}
                tmin: "{{ state_attr(climate,'min_temp')|float(5) }}"
                tmax: "{{ state_attr(climate,'max_temp')|float(30) }}"
                raw_target: "{{ (comfort_base + boost_offset)|float }}"
                target: >-
                  {% set x = raw_target|float %}
                  {% if x < tmin %}{{ tmin }}
                  {% elif x > tmax %}{{ tmax }}
                  {% else %}{{ x }}
                  {% endif %}

            - action: climate.set_temperature
              target:
                entity_id: "{{ climate }}"
              data:
                temperature: "{{ target|round(1) }}"

            - action: logbook.log
              data:
                name: "Boost ‚Üí {{ repeat.item.name }}"
                message: "C√≠l {{ target|round(1) }} ¬∞C (zdroj={{ last }}, offset={{ boost_offset }})"
                entity_id: "{{ climate }}"

  # ‚èπ Ka≈ædou minutu hl√≠dej vypr≈°en√≠ ‚Üí zhasni tlaƒç√≠tko
  - id: heating_boost_auto_clear_button
    alias: "Topen√≠: po vypr≈°en√≠ Boostu vypnout tlaƒç√≠tko"
    mode: queued
    triggers:
      - trigger: time_pattern
        minutes: "/1"
    conditions:
      - condition: template
        value_template: >-
          {% set uts = as_timestamp(states('input_datetime.boost_until'), default=0) %}
          {{ is_state('input_boolean.boost_now','on') and now().timestamp() > uts }}
    actions:
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.boost_now

  # üîÅ Boost OFF ‚Üí reapply schedule (pokud pou≈æ√≠v√°≈° END akce rozvrh≈Ø)
  - id: heating_boost_reapply_schedule_off
    alias: "Boost: po skonƒçen√≠ znovu aplikuj rozvrh"
    mode: restart
    triggers:
      - trigger: state
        entity_id: binary_sensor.kotel_boost_active
        to: "off"
    actions:
      - action: automation.trigger
        target:
          entity_id:
            - automation.sched_prizemi_michal_end
            - automation.sched_1p_jidelna_end
            - automation.sched_2p_mama_end
