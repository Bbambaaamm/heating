# YAML 2024.10
# =====================================================================
# ğŸ§  SOUBOR: /config/heating/control/mode_logic.yaml
# =====================================================================
# ğŸ›ï¸ LOGIKA REÅ½IMÅ® TOPENÃ (Auto / Eco / Boost / Off)
# - Reaguje na zmÄ›nu input_select.topny_rezim
# - PÅ™i Off okamÅ¾itÄ› vypne kotel (Aqara T2 relÃ©)
# - OstatnÃ­ reÅ¾imy pouze loguje (vlastnÃ­ prahy Å™eÅ¡Ã­ policy/mode engine)
# =====================================================================

automation:
  - alias: "TopenÃ­ â€“ logika reÅ¾imÅ¯ (ÄistÃ¡)"
    id: heating_mode_logic_clean
    description: "Reaguje na zmÄ›nu reÅ¾imu. Pro Off vypne kotel; ostatnÃ­ reÅ¾imy pouze loguje."
    mode: restart

    # ğŸ›ï¸ SpouÅ¡tÄ›Ä: zmÄ›na reÅ¾imu topenÃ­
    triggers:
      - trigger: state
        entity_id: input_select.topny_rezim

    # ğŸ›¡ï¸ Odfiltruj planÃ© pÅ™echody (kdyÅ¾ se hodnota nezmÄ›nila)
    conditions:
      - condition: template
        value_template: "{{ trigger.from_state is not none and trigger.from_state.state != trigger.to_state.state }}"

    actions:
      - choose:
          # ğŸ”» REÅ½IM OFF â†’ okamÅ¾itÃ© vypnutÃ­ kotle
          - conditions:
              - condition: state
                entity_id: input_select.topny_rezim
                state: "Off"
            sequence:
              - action: switch.turn_off
                target:
                  entity_id: switch.kotel_rele_spinac
              - action: logbook.log
                data:
                  name: "TopenÃ­ â€“ reÅ¾imy"
                  message: "ReÅ¾im pÅ™epnut na Off â†’ kotel vypnut."
                  entity_id: switch.kotel_rele_spinac
              # (volitelnÃ©) notifikace do mobilu â€“ odkomentuj a nahraÄ tvÃ½m notify targetem
              # - action: notify.mobile_app_tvuj_telefon
              #   data:
              #     title: "TopenÃ­ vypnuto"
              #     message: "ReÅ¾im pÅ™epnut na Off â†’ kotel vypnut."

          # ğŸ”¸ REÅ½IM AUTO â†’ standardnÃ­ provoz (prÃ¡hy Å™eÅ¡Ã­ policy/mode engine)
          - conditions:
              - condition: state
                entity_id: input_select.topny_rezim
                state: "Auto"
            sequence:
              - action: logbook.log
                data:
                  name: "TopenÃ­ â€“ reÅ¾imy"
                  message: "ReÅ¾im Auto â†’ pouÅ¾Ã­vajÃ­ se ÃºÄinnÃ© prahy (policy/mode_engine)."
                  entity_id: input_select.topny_rezim

          # ğŸŒ¿ REÅ½IM ECO â†’ ÃºspornÄ›jÅ¡Ã­ reÅ¾im (pÅ™Ã­snÄ›jÅ¡Ã­ prahy)
          - conditions:
              - condition: state
                entity_id: input_select.topny_rezim
                state: "Eco"
            sequence:
              - action: logbook.log
                data:
                  name: "TopenÃ­ â€“ reÅ¾imy"
                  message: "ReÅ¾im Eco â†’ pÅ™Ã­snÄ›jÅ¡Ã­ ÃºÄinnÃ© prahy (policy/mode_engine)."
                  entity_id: input_select.topny_rezim

          # âš¡ REÅ½IM BOOST â†’ krÃ¡tkodobÃ© â€pÅ™itopâ€œ (uvolnÄ›nÃ© prahy + ÄasovÃ¡nÃ­)
          - conditions:
              - condition: state
                entity_id: input_select.topny_rezim
                state: "Boost"
            sequence:
              - action: logbook.log
                data:
                  name: "TopenÃ­ â€“ reÅ¾imy"
                  message: "ReÅ¾im Boost â†’ uvolnÄ›nÃ© prahy + ÄasovÃ¡nÃ­ (mode_engine)."
                  entity_id: input_select.topny_rezim

        # ğŸ“ Default: napÅ™. nÃ¡vrat z Off do Auto/Eco/Boost â€” pÅ™ehlednÃ½ log
        default:
          - condition: template
            value_template: "{{ trigger.from_state.state == 'Off' and trigger.to_state.state in ['Auto','Eco','Boost'] }}"
          - action: logbook.log
            data:
              name: "TopenÃ­ â€“ reÅ¾imy"
              message: "ReÅ¾im z Off â†’ {{ trigger.to_state.state }} (kotel mÅ¯Å¾e znovu spÃ­nat podle policy)."
              entity_id: input_select.topny_rezim
