# =====================================================================
# ğŸ§  SOUBOR: /config/heating/mode_logic.yaml
# =====================================================================
# ğŸ›ï¸ Logika pÅ™epÃ­nÃ¡nÃ­ reÅ¾imÅ¯ topenÃ­ (Auto / Eco / Boost / Off)
# -------------------------------------------------------------
# Tento soubor Å™Ã­dÃ­, jak se mÄ›nÃ­ prahy a chovÃ¡nÃ­ kotle podle zvolenÃ©ho reÅ¾imu.
# Obsahuje takÃ© logiku pro "Boost" (krÃ¡tkodobÃ© intenzivnÃ­ topenÃ­ mimo plÃ¡n).
#
# ğŸ”¹ REÅ½IMY:
#   - Auto  â†’ standardnÃ­ chovÃ¡nÃ­ dle bÄ›Å¾nÃ½ch prahÅ¯
#   - Eco   â†’ ÃºspornÄ›jÅ¡Ã­ â€“ topÃ­ mÃ©nÄ› Äasto
#   - Boost â†’ okamÅ¾itÃ½ nÃ¡bÄ›h tepla po omezenÃ½ Äas (napÅ™. 60 min)
#   - Off   â†’ ÃºplnÃ© vypnutÃ­ topenÃ­ (kotel blokovÃ¡n)
#
# ğŸ”¹ BOOST NOW:
#   - ruÄnÄ› spustÃ­ reÅ¾im Boost (pÅ™es input_boolean.boost_now)
#   - po uplynutÃ­ nastavenÃ© doby (input_number.boost_minutes) se vrÃ¡tÃ­ do reÅ¾imu Auto
# =====================================================================

automation:
  - alias: "TopenÃ­ â€“ logika reÅ¾imÅ¯"
    id: "heating_mode_logic"
    description: "Reaguje na zmÄ›nu reÅ¾imu topenÃ­ a upravuje parametry kotle."
    mode: restart                     # novÃ© spuÅ¡tÄ›nÃ­ ukonÄÃ­ pÅ™edchozÃ­ bÄ›h (ochrana proti pÅ™ekryvÅ¯m)

    # ------------------------------------------------------------
    # ğŸ§© SPUÅ TÄšNÃ AUTOMATIZACE
    # ------------------------------------------------------------
    trigger:
      # SpouÅ¡tÃ­ se pÅ™i zmÄ›nÄ› reÅ¾imu topenÃ­ (Auto / Eco / Boost / Off)
      - platform: state
        entity_id: input_select.topny_rezim

      # SpouÅ¡tÃ­ se i pÅ™i ruÄnÃ­ aktivaci Boostu
      - platform: state
        entity_id: input_boolean.boost_now
        to: "on"

    # ------------------------------------------------------------
    # ğŸ§© HLAVNÃ AKCE â€“ pÅ™epÃ­nÃ¡nÃ­ logiky podle reÅ¾imu
    # ------------------------------------------------------------
    action:
      - choose:

          # ========================================================
          # ğŸ”¹ REÅ½IM AUTO â€“ standardnÃ­ provoz
          # ========================================================
          - conditions:
              - condition: state
                entity_id: input_select.topny_rezim
                state: "Auto"
            sequence:
              # Odblokuj kotel (vypni pÅ™Ã­padnÃ½ "Off block")
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.kotel_mode_off_block

              # Nastav prahy kotle na standardnÃ­ hodnoty
              - service: input_number.set_value
                data:
                  entity_id: input_number.kotel_min_avg_demand_pct
                  value: 15          # min. prÅ¯mÄ›rnÃ¡ poptÃ¡vka zÃ³n pro zapnutÃ­
              - service: input_number.set_value
                data:
                  entity_id: input_number.kotel_min_active_zones
                  value: 2           # min. poÄet aktivnÃ­ch zÃ³n pro zapnutÃ­ kotle

          # ========================================================
          # ğŸ”¹ REÅ½IM ECO â€“ ÃºspornÄ›jÅ¡Ã­ (vyÅ¡Å¡Ã­ prahy pro zapnutÃ­)
          # ========================================================
          - conditions:
              - condition: state
                entity_id: input_select.topny_rezim
                state: "Eco"
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.kotel_mode_off_block

              # ZpÅ™Ã­sni podmÃ­nky pro zapnutÃ­ kotle
              - service: input_number.set_value
                data:
                  entity_id: input_number.kotel_min_avg_demand_pct
                  value: 25          # kotel zapÃ­nÃ¡ aÅ¾ pÅ™i vÄ›tÅ¡Ã­m prÅ¯mÄ›rnÃ©m poÅ¾adavku
              - service: input_number.set_value
                data:
                  entity_id: input_number.kotel_min_active_zones
                  value: 3           # zapnutÃ­ aÅ¾ pÅ™i vÃ­ce aktivnÃ­ch zÃ³nÃ¡ch

          # ========================================================
          # ğŸ”¹ REÅ½IM BOOST â€“ okamÅ¾itÃ© topenÃ­ (na omezenou dobu)
          # ========================================================
          - conditions:
              - condition: state
                entity_id: input_select.topny_rezim
                state: "Boost"
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.kotel_mode_off_block

              # SniÅ¾ prahy na minimum (okamÅ¾itÃ© spuÅ¡tÄ›nÃ­ kotle)
              - service: input_number.set_value
                data:
                  entity_id: input_number.kotel_min_avg_demand_pct
                  value: 5           # kotel spÃ­nÃ¡ uÅ¾ pÅ™i 5 % poptÃ¡vce
              - service: input_number.set_value
                data:
                  entity_id: input_number.kotel_min_active_zones
                  value: 1           # staÄÃ­ jedna aktivnÃ­ zÃ³na

              # Nastav Äas, do kdy Boost platÃ­ (aktuÃ¡lnÃ­ Äas + dÃ©lka Boostu)
              - service: input_datetime.set_datetime
                data:
                  entity_id: input_datetime.boost_until
                  datetime: "{{ (now() + timedelta(minutes = states('input_number.boost_minutes') | int)) | as_datetime | as_local }}"

          # ========================================================
          # ğŸ”¹ REÅ½IM OFF â€“ kompletnÃ­ vypnutÃ­ topenÃ­
          # ========================================================
          - conditions:
              - condition: state
                entity_id: input_select.topny_rezim
                state: "Off"
            sequence:
              # Aktivuj blokaci kotle (kotel se nesepne ani pÅ™i poÅ¾adavku)
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.kotel_mode_off_block

              # OkamÅ¾itÄ› vypni Aqara T2 relÃ© (kotel)
              - service: switch.turn_off
                target:
                  entity_id: switch.aqara_lumi_switch_acn047_spinac

              # Vypni vÅ¡echny aktivnÃ­ zÃ³novÃ© poÅ¾adavky
              - service: input_boolean.turn_off
                target:
                  entity_id:
                    - input_boolean.zonovy_ohrev_prizemi_michal
                    - input_boolean.zonovy_ohrev_1p_kuchyn_jidelna
                    - input_boolean.zonovy_ohrev_2p_mama

      # ------------------------------------------------------------
      # ğŸ§¨ BOOST NOW â€“ ruÄnÃ­ spuÅ¡tÄ›nÃ­ z UI (mimo plÃ¡n)
      # ------------------------------------------------------------
      - choose:
          - conditions:
              - condition: state
                entity_id: input_boolean.boost_now
                state: "on"
            sequence:
              # PÅ™epni reÅ¾im na Boost
              - service: input_select.select_option
                data:
                  entity_id: input_select.topny_rezim
                  option: "Boost"

              # Po uplynutÃ­ dÃ©lky Boostu (v minutÃ¡ch) vraÅ¥ reÅ¾im zpÄ›t na Auto
              - delay: "{{ states('input_number.boost_minutes') | int * 60 }}"
              - service: input_select.select_option
                data:
                  entity_id: input_select.topny_rezim
                  option: "Auto"

              # Vypni ruÄnÃ­ pÅ™epÃ­naÄ Boost_now, aby byl pÅ™ipraven na dalÅ¡Ã­ pouÅ¾itÃ­
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.boost_now
