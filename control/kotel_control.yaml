# YAML 2024.10
# =====================================================================
# üß† SOUBOR: /config/heating/control/kotel_control.yaml
# =====================================================================
# üìå C√çL:
# Tento modul zaji≈°≈•uje automatick√© ≈ô√≠zen√≠ kotle (Aqara T2) podle
# popt√°vky z√≥n, re≈æimu topen√≠ a konfigurovan√Ωch prah≈Ø.
#
# üí° Logika:
#   - ‚ÄûZapni kotel‚Äú ‚Üí kdy≈æ jsou splnƒõny v≈°echny prahy (AND)
#   - ‚ÄûVypni kotel‚Äú ‚Üí kdy≈æ prahy p≈ôestanou platit nebo je aktivn√≠ blokace
#   - Zahrnuje anti-cycling zpo≈ædƒõn√≠ (ON/OFF delay)
#
# üß© Vstupy:
#   - input_boolean.topny_system_enable
#   - input_select.topny_rezim
#   - binary_sensor.kotel_threshold_any_ok
#   - binary_sensor.kotel_mode_off_block
#   - sensor.kotel_effective_on_delay_sec / off_delay_sec
#   - sensor.kotel_aktivni_zony_pocet / kotel_poptavka_prumer
#
# ‚ö° V√Ωstup:
#   - switch.kotel_rele_spinac (Aqara T2 rel√©)
# =====================================================================

automation:
  # ---------------------------------------------------------------
  # ‚ñ∂Ô∏è ZAPNOUT KOTEL
  # ---------------------------------------------------------------
  - id: kotel_turn_on_by_policy
    alias: "Kotel: zapnout p≈ôi splnƒõn√≠ politiky"
    description: "Zapne rel√© kotle po zpo≈ædƒõn√≠, pokud plat√≠ prahy a nen√≠ blokace."
    mode: restart

    triggers:
      - trigger: state
        entity_id:
          - binary_sensor.kotel_threshold_any_ok
          - binary_sensor.kotel_mode_off_block
          - input_boolean.topny_system_enable
          - input_select.topny_rezim
          - input_boolean.boost_now
          - input_datetime.boost_until
          - input_number.kotel_on_delay_sec
          - sensor.kotel_aktivni_zony_pocet
          - sensor.kotel_poptavka_prumer
          - sensor.kotel_poptavka_max

    condition:
      - condition: state
        entity_id: input_boolean.topny_system_enable
        state: "on"
      - condition: state
        entity_id: binary_sensor.kotel_mode_off_block
        state: "off"
      - condition: state
        entity_id: binary_sensor.kotel_threshold_any_ok
        state: "on"

    actions:
      - delay:
          seconds: "{{ states('sensor.kotel_effective_on_delay_sec') | int(0) }}"
      - choose:
          - conditions:
              - condition: state
                entity_id: input_boolean.topny_system_enable
                state: "on"
              - condition: state
                entity_id: binary_sensor.kotel_mode_off_block
                state: "off"
              - condition: state
                entity_id: binary_sensor.kotel_threshold_any_ok
                state: "on"
            sequence:
              - action: switch.turn_on
                target:
                  entity_id: switch.kotel_rele_spinac

  # ---------------------------------------------------------------
  # ‚èπ VYPNOUT KOTEL
  # ---------------------------------------------------------------
  - id: kotel_turn_off_by_policy
    alias: "Kotel: vypnout p≈ôi nesplnƒõn√≠ politiky / blokaci"
    description: "Vypne rel√© kotle po zpo≈ædƒõn√≠, kdy≈æ prahy neplat√≠, re≈æim je Off, nebo master OFF."
    mode: restart

    triggers:
      - trigger: state
        entity_id:
          - binary_sensor.kotel_threshold_any_ok
          - binary_sensor.kotel_mode_off_block
          - input_boolean.topny_system_enable
          - input_select.topny_rezim
          - input_boolean.boost_now
          - input_datetime.boost_until
          - input_number.kotel_off_delay_sec
          - sensor.kotel_aktivni_zony_pocet
          - sensor.kotel_poptavka_prumer
          - sensor.kotel_poptavka_max

    condition: []

    action:
      - choose:
          # ‚õî Master OFF
          - conditions:
              - condition: state
                entity_id: input_boolean.topny_system_enable
                state: "off"
            sequence:
              - delay:
                  seconds: "{{ states('sensor.kotel_effective_off_delay_sec') | int(0) }}"
              - choose:
                  - conditions:
                      - condition: state
                        entity_id: input_boolean.topny_system_enable
                        state: "off"
                    sequence:
                      - action: switch.turn_off
                        target:
                          entity_id: switch.kotel_rele_spinac

          # ‚õî Re≈æim Off
          - conditions:
              - condition: state
                entity_id: binary_sensor.kotel_mode_off_block
                state: "on"
            sequence:
              - delay:
                  seconds: "{{ states('sensor.kotel_effective_off_delay_sec') | int(0) }}"
              - choose:
                  - conditions:
                      - condition: state
                        entity_id: binary_sensor.kotel_mode_off_block
                        state: "on"
                    sequence:
                      - action: switch.turn_off
                        target:
                          entity_id: switch.kotel_rele_spinac

          # ‚õî Nesplnƒõn√© prahy
          - conditions:
              - condition: state
                entity_id: binary_sensor.kotel_threshold_any_ok
                state: "off"
            sequence:
              - delay:
                  seconds: "{{ states('sensor.kotel_effective_off_delay_sec') | int(0) }}"
              - choose:
                  - conditions:
                      - condition: state
                        entity_id: binary_sensor.kotel_threshold_any_ok
                        state: "off"
                    sequence:
                      - action: switch.turn_off
                        target:
                          entity_id: switch.kotel_rele_spinac
