# YAML 2024.10
# =====================================================================
# ğŸ§  /config/heating/control/mode_engine.yaml â€“ BOOST LOGIKA (only)
# =====================================================================

template:

  # â”€â”€ BOOST aktivnÃ­? (reÅ¾im Boost NEBO tlaÄÃ­tko NEBO do-Äasu) â”€â”€â”€â”€â”€â”€â”€â”€
  - binary_sensor:
      - name: "kotel_boost_active"
        unique_id: kotel_boost_active
        device_class: heat
        state: >-
          {{
            is_state('input_select.topny_rezim','Boost')
            or is_state('input_boolean.boost_now','on')
            or (
                 states('input_datetime.boost_until') not in ['unknown','unavailable','']
                 and now() < as_datetime(states('input_datetime.boost_until'))
               )
          }}
        attributes:
          until: >-
            {{ states('input_datetime.boost_until') if
               states('input_datetime.boost_until') not in ['unknown','unavailable',''] else '' }}
          remaining_min: >-
            {% if states('input_datetime.boost_until') not in ['unknown','unavailable',''] %}
              {{ ((as_datetime(states('input_datetime.boost_until')) - now()).total_seconds() / 60) | round(0) }}
            {% else %} 0 {% endif %}

# =====================================================================
# ğŸ¤– AUTOMATIZACE PRO BOOST
# =====================================================================
automation:

  # â–¶ï¸ Start Boostu â€“ z reÅ¾imu nebo tlaÄÃ­tkem â†’ nastav boost_until
  - id: heating_boost_start
    alias: "TopenÃ­: start Boostu (nastav boost_until)"
    mode: restart
    triggers:
      - trigger: state
        entity_id: input_select.topny_rezim
        to: "Boost"
      - trigger: state
        entity_id: input_boolean.boost_now
        to: "on"
    actions:
      - variables:
          minutes: "{{ states('input_number.boost_minutes') | int(60) }}"
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.boost_until
        data:
          datetime: "{{ (now() + timedelta(minutes=minutes)).isoformat() }}"

  # âš¡ KdyÅ¾ Boost pÅ™ejde na ON â†’ poÅ¡li komfort do vÅ¡ech zÃ³n
  - id: heating_boost_apply_comfort_on
    alias: "Boost: pÅ™i startu nastav komfort do vÅ¡ech zÃ³n"
    mode: restart
    triggers:
      - trigger: state
        entity_id: binary_sensor.kotel_boost_active
        to: "on"
    actions:
      - action: script.schedule_set_zone_comfort
        data:
          climate_entity: climate.prizemi_michal
          last_user_temp_sensor: sensor.last_user_temp_prizemi_michal
      - action: script.schedule_set_zone_comfort
        data:
          climate_entity: climate.1p_jidelna
          last_user_temp_sensor: sensor.last_user_temp_1p_jidelna
      - action: script.schedule_set_zone_comfort
        data:
          climate_entity: climate.2p_mama
          last_user_temp_sensor: sensor.last_user_temp_2p_mama

  # â¹ KaÅ¾dou minutu hlÃ­dej vyprÅ¡enÃ­ â†’ zhasni tlaÄÃ­tko
  - id: heating_boost_auto_clear_button
    alias: "TopenÃ­: po vyprÅ¡enÃ­ Boostu vypnout tlaÄÃ­tko"
    mode: queued
    triggers:
      - trigger: time_pattern
        minutes: "/1"
    condition:
      - condition: template
        value_template: >-
          {% set uts = as_timestamp(states('input_datetime.boost_until'), default=0) %}
          {{ is_state('input_boolean.boost_now','on') and now().timestamp() > uts }}
    actions:
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.boost_now

  # ğŸ” KdyÅ¾ Boost skonÄÃ­ â†’ znovu aplikuj rozvrh (setback/komfort dle okna)
  - id: heating_boost_reapply_schedule_off
    alias: "Boost: po skonÄenÃ­ znovu aplikuj rozvrh"
    mode: restart
    triggers:
      - trigger: state
        entity_id: binary_sensor.kotel_boost_active
        to: "off"
    actions:
      # Pokud pouÅ¾Ã­vÃ¡Å¡ schedule_engine start/end automace, triggerni jejich END:
      - action: automation.trigger
        target:
          entity_id:
            - automation.sched_prizemi_michal_end
            - automation.sched_1p_jidelna_end
            - automation.sched_2p_mama_end
