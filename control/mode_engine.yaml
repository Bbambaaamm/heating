# =====================================================================
# ğŸšï¸ HEATING / MODE ENGINE
# Å˜Ã­dÃ­ globÃ¡lnÃ­ reÅ¾imy topenÃ­:
#   - Auto  â€¦ pouÅ¾Ã­vÃ¡ prahy z policy_config.yaml beze zmÄ›ny
#   - Eco   â€¦ pÅ™Ã­snÄ›jÅ¡Ã­ prahy (vyÅ¡Å¡Ã­ nÃ¡roky na zapnutÃ­ kotle)
#   - Boost â€¦ uvolnÄ›nÃ© prahy + ÄasovÄ› omezenÃ© â€pÅ™itopâ€œ
#   - Off   â€¦ tvrdÃ¡ blokace spÃ­nÃ¡nÃ­ kotle
#
# VSTUPNÃ ENTITy (musÃ­ uÅ¾ existovat z pÅ™edchozÃ­ch krokÅ¯):
#   input_select.topny_rezim
#   input_boolean.topny_system_enable
#   input_boolean.boost_now
#   input_number.boost_minutes
#   input_datetime.boost_until
#   input_number.kotel_min_active_zones
#   input_number.kotel_min_avg_demand_pct
#   input_number.kotel_on_delay_sec
#   input_number.kotel_off_delay_sec
#
# VÃSTUPNÃ / ODVOZENÃ‰ ENTITy (tady definujeme):
#   binary_sensor.kotel_boost_active          â€¦ â€Boost aktivnÃ­?â€œ (podle reÅ¾imu / ÄasovaÄe)
#   binary_sensor.kotel_mode_off_block        â€¦ blokace kotle (Off / master OFF)
#   sensor.kotel_effective_min_active_zones   â€¦ ÃºÄinnÃ© min. aktivnÃ­ch zÃ³n (podle reÅ¾imu)
#   sensor.kotel_effective_min_avg_demand_pct â€¦ ÃºÄinnÃ¡ min. prÅ¯mÄ›rnÃ¡ poptÃ¡vka (%)
#   sensor.kotel_effective_on_delay_sec       â€¦ ÃºÄinnÃ© zpoÅ¾dÄ›nÃ­ zapnutÃ­ (s)
#   sensor.kotel_effective_off_delay_sec      â€¦ ÃºÄinnÃ© zpoÅ¾dÄ›nÃ­ vypnutÃ­ (s)
#
# POZN.: Logika spÃ­nÃ¡nÃ­ kotle (kotel_control.yaml) mÃ¡ ÄÃ­st VÅ½DY â€effective_*â€œ
#        a respektovat â€kotel_mode_off_blockâ€œ + â€kotel_boost_activeâ€œ.
# =====================================================================

template:

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â±ï¸ BOOST â€“ AktivnÃ­?
  #   - Aktivuje se, kdyÅ¾:
  #       a) reÅ¾im je pÅ™Ã­mo â€Boostâ€œ NEBO
  #       b) je zapnutÃ© tlaÄÃ­tko boost_now NEBO
  #       c) je â€teÄâ€œ < boost_until
  #   - DÃ­ky tomu Boost platÃ­ i pÅ™i manuÃ¡lnÃ­m â€Boost â€“ zapnout nynÃ­â€œ
  #     na zadanÃ© obdobÃ­ (boost_minutes) â€“ viz automatizace nÃ­Å¾e.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - binary_sensor:
      - name: "kotel_boost_active"
        unique_id: kotel_boost_active
        state: >
          {% set mode  = states('input_select.topny_rezim') %}
          {% set bn    = is_state('input_boolean.boost_now','on') %}
          {% set until = states('input_datetime.boost_until') %}
          {% set nowts = now().timestamp() %}
          {% set uts   = as_timestamp(until, default=0) %}
          {{ mode == 'Boost' or bn or (nowts < uts) }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â›” BLOKACE KOTLE â€“ OFF / master OFF
  #   - Kotel nesmÃ­ spÃ­nat, pokud:
  #       a) reÅ¾im je â€Offâ€œ NEBO
  #       b) master povolenÃ­ (topny_system_enable) je OFF
  #   - Tuto blokaci musÃ­ brÃ¡t v potaz logika spÃ­nÃ¡nÃ­ (kotel_control).
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - binary_sensor:
      - name: "kotel_mode_off_block"
        unique_id: kotel_mode_off_block
        state: >
          {{ is_state('input_select.topny_rezim','Off')
             or is_state('input_boolean.topny_system_enable','off') }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸšï¸ ÃšÄŒINNÃ‰ PRAHY â€“ podle reÅ¾imu:
  #   * Auto  â†’ pouÅ¾ij vstupnÃ­ hodnoty beze zmÄ›ny
  #   * Eco   â†’ zvedni prahy (pÅ™Ã­snÄ›jÅ¡Ã­):
  #              - min_active_zones +1  (min 1)
  #              - min_avg_demand +10 %
  #              - on_delay + 30 s
  #              - off_delay + 60 s
  #   * Boost â†’ uvolni prahy:
  #              - min_active_zones = 1
  #              - min_avg_demand = 0 %
  #              - on_delay = 0 s
  #              - off_delay = MAX( vstupnÃ­ off_delay, 300 s )  (nech topenÃ­ dÃ©le dobÄ›hnout)
  #   * Off   â†’ hodnoty nejsou pro spÃ­nÃ¡nÃ­ relevantnÃ­ (blokuje off_block),
  #             ale nastavÃ­me je konzervativnÄ› jako v â€Autoâ€œ pro pÅ™ehlednost.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - sensor:
      - name: "kotel_effective_min_active_zones"
        unique_id: kotel_effective_min_active_zones
        state: >
          {% set mode = states('input_select.topny_rezim') %}
          {% set base = states('input_number.kotel_min_active_zones') | int(0) %}
          {% if mode == 'Eco' %}
            {{ [1, base + 1] | max }}
          {% elif mode == 'Boost' %}
            1
          {% else %}  {# Auto i Off #}
            {{ base }}
          {% endif %}

      - name: "kotel_effective_min_avg_demand_pct"
        unique_id: kotel_effective_min_avg_demand_pct
        unit_of_measurement: "%"
        state: >
          {% set mode = states('input_select.topny_rezim') %}
          {% set base = states('input_number.kotel_min_avg_demand_pct') | int(0) %}
          {% if mode == 'Eco' %}
            {{ [0, base + 10] | max }}
          {% elif mode == 'Boost' %}
            0
          {% else %}
            {{ base }}
          {% endif %}

      - name: "kotel_effective_on_delay_sec"
        unique_id: kotel_effective_on_delay_sec
        unit_of_measurement: "s"
        state: >
          {% set mode = states('input_select.topny_rezim') %}
          {% set base = states('input_number.kotel_on_delay_sec') | int(0) %}
          {% if mode == 'Eco' %}
            {{ base + 30 }}
          {% elif mode == 'Boost' %}
            0
          {% else %}
            {{ base }}
          {% endif %}

      - name: "kotel_effective_off_delay_sec"
        unique_id: kotel_effective_off_delay_sec
        unit_of_measurement: "s"
        state: >
          {% set mode = states('input_select.topny_rezim') %}
          {% set base = states('input_number.kotel_off_delay_sec') | int(0) %}
          {% if mode == 'Eco' %}
            {{ base + 60 }}
          {% elif mode == 'Boost' %}
            {{ [base, 300] | max }}
          {% else %}
            {{ base }}
          {% endif %}

# =====================================================================
# ğŸ¤– AUTOMATIZACE PRO BOOST
# - PÅ™i zapnutÃ­ Boostu nastavÃ­ "boost_until" = teÄ + boost_minutes
# - HlÃ­dÃ¡ expiraci â†’ po vyprÅ¡enÃ­ smaÅ¾e boost_now (aby UI odpovÃ­dalo realitÄ›)
# - Reaguje na:
#     a) ruÄnÃ­ pÅ™epnutÃ­ input_select.topny_rezim na "Boost"
#     b) klik na input_boolean.boost_now
# =====================================================================
automation:

  # â–¶ï¸ Start Boostu â€“ z reÅ¾imu nebo tlaÄÃ­tkem
  - id: heating_boost_start
    alias: "TopenÃ­: start Boostu (nastav boost_until)"
    mode: restart
    trigger:
      - platform: state
        entity_id: input_select.topny_rezim
        to: "Boost"
      - platform: state
        entity_id: input_boolean.boost_now
        to: "on"
    action:
      - variables:
          minutes: "{{ states('input_number.boost_minutes') | int(60) }}"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.boost_until
        data:
          datetime: "{{ (now() + timedelta(minutes=minutes)).isoformat() }}"

  # â¹ Konec Boostu â€“ automaticky zhasni tlaÄÃ­tko po vyprÅ¡enÃ­
  - id: heating_boost_auto_clear_button
    alias: "TopenÃ­: po vyprÅ¡enÃ­ Boostu vypnout tlaÄÃ­tko"
    mode: queued
    trigger:
      # kontrola kaÅ¾dou minutu, jestli uÅ¾ jsme po â€untilâ€œ
      - platform: time_pattern
        minutes: "/1"
    condition:
      - condition: template
        value_template: >
          {% set until = states('input_datetime.boost_until') %}
          {% set uts   = as_timestamp(until, default=0) %}
          {{ is_state('input_boolean.boost_now','on') and now().timestamp() > uts }}
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.boost_now
