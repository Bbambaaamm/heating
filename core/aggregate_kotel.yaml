# YAML 2024.10
#=====================================================================
# 游늵 AGREGACE pro kotel
# - kolik z칩n chce teplo (aktivn칤ch)
# - pr콢m캩rn치 popt치vka aktivn칤ch z칩n (%)
# - maxim치ln칤 popt치vka nap콏칤캜 z칩nami (%)
# - Snadno roz코i콏iteln칠: p콏idej sem dal코칤 z칩nu do seznam콢.
# =====================================================================

template:
  - sensor:
      - name: "kotel_aktivni_zony_pocet"
        unit_of_measurement: "z칩n"
        state: >
          {% set zs = [
            is_state('binary_sensor.zona_prizemi_michal_aktivni','on'),
            is_state('binary_sensor.zona_1p_jidelna_aktivni','on'),
            is_state('binary_sensor.zona_2p_mama_aktivni','on')
          ] %}
          {{ zs | select('equalto', true) | list | count }}

      - name: "kotel_poptavka_prumer"
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set demands = [] %}
          {% if is_state('binary_sensor.zona_prizemi_michal_aktivni','on') %}
            {% set demands = demands + [ states('sensor.zona_prizemi_michal_demand')|int(0) ] %}
          {% endif %}
          {% if is_state('binary_sensor.zona_1p_jidelna_aktivni','on') %}
            {% set demands = demands + [ states('sensor.zona_1p_jidelna_demand')|int(0) ] %}
          {% endif %}
          {% if is_state('binary_sensor.zona_2p_mama_aktivni','on') %}
            {% set demands = demands + [ states('sensor.zona_2p_mama_demand')|int(0) ] %}
          {% endif %}
          {{ (demands | sum / (demands|count)) | round(1) if (demands|count) > 0 else 0 }}

      - name: "kotel_poptavka_max"
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set demands = [] %}
          {% if is_state('binary_sensor.zona_prizemi_michal_aktivni','on') %}
            {% set demands = demands + [ states('sensor.zona_prizemi_michal_demand')|int(0) ] %}
          {% endif %}
          {% if is_state('binary_sensor.zona_1p_jidelna_aktivni','on') %}
            {% set demands = demands + [ states('sensor.zona_1p_jidelna_demand')|int(0) ] %}
          {% endif %}
          {% if is_state('binary_sensor.zona_2p_mama_aktivni','on') %}
            {% set demands = demands + [ states('sensor.zona_2p_mama_demand')|int(0) ] %}
          {% endif %}
          {{ (demands | max) if (demands|count) > 0 else 0 }}
