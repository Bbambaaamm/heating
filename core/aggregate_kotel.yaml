# =====================================================================
# Soubor   : config/heating/core/aggregate_kotel.yaml
# Modul    : Kotel – agregace poptávky zón
# =====================================================================

template:
  - sensor:

      # ---------------------------------------------------------------
      # SENSOR: Počet aktivních zón
      # (počítá jen zóny s demand >= kotel_min_zone_demand_pct)
      # ---------------------------------------------------------------
      - name: "kotel_aktivni_zony_pocet"
        unique_id: kotel_aktivni_zony_pocet
        unit_of_measurement: "zón"
        state: >
          {% set min_d = states('input_number.kotel_min_zone_demand_pct') | float(0) %}
          {% set zs = [
            (is_state('binary_sensor.zona_sklep_michal_aktivni','on') and (states('sensor.zona_sklep_michal_demand') | float(0)) >= min_d),
            (is_state('binary_sensor.zona_prizemi_michal_aktivni','on') and (states('sensor.zona_prizemi_michal_demand') | float(0)) >= min_d),
            (is_state('binary_sensor.zona_prizemi_chodba_zachod_aktivni','on') and (states('sensor.zona_prizemi_chodba_zachod_demand') | float(0)) >= min_d),
            (is_state('binary_sensor.zona_1p_jidelna_aktivni','on') and (states('sensor.zona_1p_jidelna_demand') | float(0)) >= min_d),
            (is_state('binary_sensor.zona_1p_kuchyn_aktivni','on') and (states('sensor.zona_1p_kuchyn_demand') | float(0)) >= min_d),
            (is_state('binary_sensor.zona_1p_koupelna_aktivni','on') and (states('sensor.zona_1p_koupelna_demand') | float(0)) >= min_d),
            (is_state('binary_sensor.zona_1p_chodba_aktivni','on') and (states('sensor.zona_1p_chodba_demand') | float(0)) >= min_d),
            (is_state('binary_sensor.zona_2p_mama_aktivni','on') and (states('sensor.zona_2p_mama_demand') | float(0)) >= min_d)
          ] %}
          {{ zs | select('equalto', true) | list | count }}


      # ---------------------------------------------------------------
      # SENSOR: Průměrná poptávka aktivních zón (%)
      # (počítá jen zóny s demand >= kotel_min_zone_demand_pct)
      # ---------------------------------------------------------------
      - name: "kotel_poptavka_prumer"
        unique_id: kotel_poptavka_prumer
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set min_d = states('input_number.kotel_min_zone_demand_pct') | float(0) %}
          {% set demands = [] %}

          {% set d = states('sensor.zona_sklep_michal_demand') | float(0) %}
          {% if is_state('binary_sensor.zona_sklep_michal_aktivni','on') and d >= min_d %}
            {% set demands = demands + [ d ] %}
          {% endif %}

          {% set d = states('sensor.zona_prizemi_michal_demand') | float(0) %}
          {% if is_state('binary_sensor.zona_prizemi_michal_aktivni','on') and d >= min_d %}
            {% set demands = demands + [ d ] %}
          {% endif %}

          {% set d = states('sensor.zona_prizemi_chodba_zachod_demand') | float(0) %}
          {% if is_state('binary_sensor.zona_prizemi_chodba_zachod_aktivni','on') and d >= min_d %}
            {% set demands = demands + [ d ] %}
          {% endif %}

          {% set d = states('sensor.zona_1p_jidelna_demand') | float(0) %}
          {% if is_state('binary_sensor.zona_1p_jidelna_aktivni','on') and d >= min_d %}
            {% set demands = demands + [ d ] %}
          {% endif %}

          {% set d = states('sensor.zona_1p_kuchyn_demand') | float(0) %}
          {% if is_state('binary_sensor.zona_1p_kuchyn_aktivni','on') and d >= min_d %}
            {% set demands = demands + [ d ] %}
          {% endif %}

          {% set d = states('sensor.zona_1p_koupelna_demand') | float(0) %}
          {% if is_state('binary_sensor.zona_1p_koupelna_aktivni','on') and d >= min_d %}
            {% set demands = demands + [ d ] %}
          {% endif %}

          {% set d = states('sensor.zona_1p_chodba_demand') | float(0) %}
          {% if is_state('binary_sensor.zona_1p_chodba_aktivni','on') and d >= min_d %}
            {% set demands = demands + [ d ] %}
          {% endif %}

          {% set d = states('sensor.zona_2p_mama_demand') | float(0) %}
          {% if is_state('binary_sensor.zona_2p_mama_aktivni','on') and d >= min_d %}
            {% set demands = demands + [ d ] %}
          {% endif %}

          {{ ((demands | sum) / (demands | count)) | round(1) if (demands | count) > 0 else 0 }}


      # ---------------------------------------------------------------
      # SENSOR: Maximální poptávka aktivních zón (%)
      # (počítá jen zóny s demand >= kotel_min_zone_demand_pct)
      # ---------------------------------------------------------------
      - name: "kotel_poptavka_max"
        unique_id: kotel_poptavka_max
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set min_d = states('input_number.kotel_min_zone_demand_pct') | float(0) %}
          {% set demands = [] %}

          {% if is_state('binary_sensor.zona_sklep_michal_aktivni','on')
                and (states('sensor.zona_sklep_michal_demand') | float(0)) >= min_d %}
            {% set demands = demands + [ states('sensor.zona_sklep_michal_demand') | float(0) ] %}
          {% endif %}

          {% if is_state('binary_sensor.zona_prizemi_michal_aktivni','on')
                and (states('sensor.zona_prizemi_michal_demand') | float(0)) >= min_d %}
            {% set demands = demands + [ states('sensor.zona_prizemi_michal_demand') | float(0) ] %}
          {% endif %}

          {% if is_state('binary_sensor.zona_prizemi_chodba_zachod_aktivni','on')
                and (states('sensor.zona_prizemi_chodba_zachod_demand') | float(0)) >= min_d %}
            {% set demands = demands + [ states('sensor.zona_prizemi_chodba_zachod_demand') | float(0) ] %}
          {% endif %}

          {% if is_state('binary_sensor.zona_1p_jidelna_aktivni','on')
                and (states('sensor.zona_1p_jidelna_demand') | float(0)) >= min_d %}
            {% set demands = demands + [ states('sensor.zona_1p_jidelna_demand') | float(0) ] %}
          {% endif %}

          {% if is_state('binary_sensor.zona_1p_kuchyn_aktivni','on')
                and (states('sensor.zona_1p_kuchyn_demand') | float(0)) >= min_d %}
            {% set demands = demands + [ states('sensor.zona_1p_kuchyn_demand') | float(0) ] %}
          {% endif %}

          {% if is_state('binary_sensor.zona_1p_koupelna_aktivni','on')
                and (states('sensor.zona_1p_koupelna_demand') | float(0)) >= min_d %}
            {% set demands = demands + [ states('sensor.zona_1p_koupelna_demand') | float(0) ] %}
          {% endif %}

          {% if is_state('binary_sensor.zona_1p_chodba_aktivni','on')
                and (states('sensor.zona_1p_chodba_demand') | float(0)) >= min_d %}
            {% set demands = demands + [ states('sensor.zona_1p_chodba_demand') | float(0) ] %}
          {% endif %}

          {% if is_state('binary_sensor.zona_2p_mama_aktivni','on')
                and (states('sensor.zona_2p_mama_demand') | float(0)) >= min_d %}
            {% set demands = demands + [ states('sensor.zona_2p_mama_demand') | float(0) ] %}
          {% endif %}

          {{ demands | max if demands | count > 0 else 0 }}


  - binary_sensor:
      - name: "kotel_should_be_on"
        unique_id: kotel_should_be_on
        device_class: heat
        state: >-
          {{ is_state('binary_sensor.kotel_threshold_all_ok', 'on')
             and is_state('binary_sensor.kotel_mode_off_block', 'off') }}
        attributes:
          aktivni_zony: "{{ states('sensor.kotel_aktivni_zony_pocet') }}"
          prumerna_poptavka: "{{ states('sensor.kotel_poptavka_prumer') }}"
          boost_active: "{{ states('binary_sensor.kotel_boost_active') }}"
