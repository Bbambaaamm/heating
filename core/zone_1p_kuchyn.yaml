# =====================================================================
# Soubor   : config/heating/core/zone_1p_kuchyn.yaml
# Modul    : Zóna – 1. patro Jídelna
# Účel     : Logika zóny (poptávka, okno, aktivita topení)
# Autor    : Michal
# Poslední úprava : 2025-11-19
# Poznámka : Výstupy: demand %, okno otevřené, zóna aktivní
# =====================================================================

template:
  # ===================================================================
  # SEKCE: Zóna 1P Jídelna – senzory
  # ===================================================================
  - sensor:
      # ----------------------------------------------------------------
      # SENSOR: Požadavek na topení (%)
      # Logika:
      # - čte pi_heating_demand z climate.1p_jidelna
      # - výstup je procento (0–100)
      # ----------------------------------------------------------------
      - name: "zona_1p_jidelna_demand"
        unique_id: zona_1p_jidelna_demand
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {{ state_attr('climate.1p_jidelna', 'pi_heating_demand') | int(0) }}

  - binary_sensor:
      # ----------------------------------------------------------------
      # SENSOR: Okno otevřené v zóně 1P Jídelna
      # Logika:
      # - čte stav sensor.1p_jidelna_detekovano_otevrene_okno
      # - pokud není explicitně "closed" → bere se jako otevřeno
      #   (včetně unknown/unavailable/other)
      # ----------------------------------------------------------------
      - name: "zona_1p_jidelna_okno_otevrene"
        unique_id: zona_1p_jidelna_okno_otevrene
        device_class: opening
        state: >
          {% set s = states('sensor.1p_jidelna_detekovano_otevrene_okno') %}
          {{ s is not string or s|lower != 'closed' }}

      # ----------------------------------------------------------------
      # SENSOR: Zóna 1P Jídelna aktivní (topení skutečně běží)
      # Logika:
      # - true, pokud:
      #   - demand > 1 %
      #   - a současně není detekováno otevřené okno
      # ----------------------------------------------------------------
      - name: "zona_1p_jidelna_aktivni"
        unique_id: zona_1p_jidelna_aktivni
        state: >
          {{ (states('sensor.zona_1p_jidelna_demand')|int(0) > 1)
             and (not is_state('binary_sensor.zona_1p_jidelna_okno_otevrene','on')) }}
