# YAML 2024.10
# =====================================================================
# ðŸ§  SOUBOR: /config/heating/policy/policy_effective.yaml
# =====================================================================
# ðŸ§® EFFECTIVE PRAHY â€“ odvozenÃ© z reÅ¾imu (Auto / Eco / Boost / Off)
# =====================================================================

template:

  # -------------------------------------------------------------------
  # ðŸ”¢ SENZORY â€“ ÃºÄinnÃ© prahy a zpoÅ¾dÄ›nÃ­
  # -------------------------------------------------------------------
  - sensor:
      # â†’ efektivnÃ­ prÅ¯mÄ›rnÃ¡ poptÃ¡vka (%) podle reÅ¾imu/Boost
      - name: "kotel_effective_min_avg_demand_pct"
        unique_id: kotel_effective_min_avg_demand_pct
        unit_of_measurement: "%"
        state: >-
          {% set base  = states('input_number.kotel_min_avg_demand_pct') | int(15) %}
          {% set mode  = states('input_select.topny_rezim') %}
          {% set boost = is_state('binary_sensor.kotel_boost_active','on') %}
          {% if mode == 'Off' %}
            999
          {% elif boost %}
            0
          {% elif mode == 'Eco' %}
            {{ [base + 10, 100] | min }}
          {% else %}
            {{ base }}
          {% endif %}

      # â†’ efektivnÃ­ min. aktivnÃ­ch zÃ³n podle reÅ¾imu/Boost
      - name: "kotel_effective_min_active_zones"
        unique_id: kotel_effective_min_active_zones
        state: >-
          {% set base  = states('input_number.kotel_min_active_zones') | int(2) %}
          {% set mode  = states('input_select.topny_rezim') %}
          {% set boost = is_state('binary_sensor.kotel_boost_active','on') %}
          {% if mode == 'Off' %}
            99
          {% elif boost %}
            1
          {% elif mode == 'Eco' %}
            {{ base + 1 }}
          {% else %}
            {{ base }}
          {% endif %}

      # â†’ efektivnÃ­ zpoÅ¾dÄ›nÃ­ zapnutÃ­ (ON delay)
      - name: "kotel_effective_on_delay_sec"
        unique_id: kotel_effective_on_delay_sec
        unit_of_measurement: "s"
        state: >-
          {% set base  = states('input_number.kotel_on_delay_sec') | int(120) %}
          {% set boost = is_state('binary_sensor.kotel_boost_active','on') %}
          {% if boost %}
            0
          {% else %}
            {{ base }}
          {% endif %}

      # â†’ efektivnÃ­ zpoÅ¾dÄ›nÃ­ vypnutÃ­ (OFF delay)
      - name: "kotel_effective_off_delay_sec"
        unique_id: kotel_effective_off_delay_sec
        unit_of_measurement: "s"
        state: >-
          {% set base  = states('input_number.kotel_off_delay_sec') | int(300) %}
          {% set mode  = states('input_select.topny_rezim') %}
          {% set boost = is_state('binary_sensor.kotel_boost_active','on') %}
          {% if mode == 'Eco' %}
            {{ base + 60 }}
          {% elif boost %}
            {{ [base, 300] | max }}
          {% else %}
            {{ base }}
          {% endif %}

  # -------------------------------------------------------------------
  # âœ… BINÃRNÃ SENZORY â€“ vyhodnocenÃ­ prahÅ¯
  # -------------------------------------------------------------------
  - binary_sensor:
      # â†’ Je splnÄ›n prÃ¡h â€žpoÄet aktivnÃ­ch zÃ³nâ€œ?
      - name: "kotel_threshold_ok_active_zones"
        unique_id: kotel_threshold_ok_active_zones
        device_class: connectivity
        state: >-
          {{ (states('sensor.kotel_aktivni_zony_pocet') | int(0)) >=
             (states('sensor.kotel_effective_min_active_zones') | int(99)) }}

      # â†’ Je splnÄ›n prÃ¡h â€žprÅ¯mÄ›rnÃ¡ poptÃ¡vkaâ€œ?
      - name: "kotel_threshold_ok_avg_demand"
        unique_id: kotel_threshold_ok_avg_demand
        device_class: connectivity
        state: >-
          {{ (states('sensor.kotel_poptavka_prumer') | float(0)) >=
             (states('sensor.kotel_effective_min_avg_demand_pct') | float(999)) }}

      # â†’ CELKOVÃ hlavnÃ­ prÃ¡h (AND)
      - name: "kotel_threshold_all_ok"
        unique_id: kotel_threshold_all_ok
        icon: mdi:checkbox-marked-circle
        state: >-
          {{ is_state('binary_sensor.kotel_threshold_ok_active_zones','on')
             and is_state('binary_sensor.kotel_threshold_ok_avg_demand','on') }}
        attributes:
          active_zones_ok: "{{ states('binary_sensor.kotel_threshold_ok_active_zones') }}"
          avg_demand_ok: "{{ states('binary_sensor.kotel_threshold_ok_avg_demand') }}"

      # â†’ reÅ¾im OFF = blokace spÃ­nÃ¡nÃ­ kotle
      - name: "kotel_mode_off_block"
        unique_id: kotel_mode_off_block
        device_class: problem
        state: >-
          {{ is_state('input_select.topny_rezim','Off')
             or is_state('input_boolean.topny_system_enable','off') }}
