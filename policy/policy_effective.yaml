# =====================================================================
# ðŸ§® Effective prahy â€“ odvozenÃ© z reÅ¾imu (Auto/Eco/Boost/Off)
# - V OFF reÅ¾imu nastavÃ­me prahy tak, aby NIKDY nezapnulo (âˆž/âˆž).
# - V ECO prahy zpÅ™Ã­snÃ­me (menÅ¡Ã­ Å¡ance zapnout).
# - V BOOST prahy uvolnÃ­me (vÄ›tÅ¡Ã­ Å¡ance zapnout rychleji).
# - V AUTO pouÅ¾ijeme pÅ™Ã­mo konfigurovanÃ© hodnoty.
# - SouÄasnÄ› pÅ™ipravÃ­me binÃ¡rnÃ­ "splnÄ›no/nesplnÄ›no" vÅ¯Äi aktuÃ¡lnÃ­m hodnotÃ¡m.
# =====================================================================

template:

  - sensor:
      # â†’ efektivnÃ­ prÅ¯mÄ›rnÃ¡ poptÃ¡vka (%) podle reÅ¾imu
      - name: "kotel_effective_min_avg_demand_pct"
        unit_of_measurement: "%"
        state: >
          {% set base = states('input_number.kotel_min_avg_demand_pct')|int(15) %}
          {% set mode = states('input_select.topny_rezim') %}
          {% if mode == 'Off' %} 999
          {% elif mode == 'Eco' %} {{ [base + 10, 100] | min }}    {# zpÅ™Ã­snit o +10 % #}
          {% elif mode == 'Boost' %} {{ [base - 10, 0] | max }}    {# povolit o -10 % #}
          {% else %} {{ base }}                                     {# Auto #}
          {% endif %}

      # â†’ efektivnÃ­ min. aktivnÃ­ch zÃ³n podle reÅ¾imu
      - name: "kotel_effective_min_active_zones"
        state: >
          {% set base = states('input_number.kotel_min_active_zones')|int(2) %}
          {% set mode = states('input_select.topny_rezim') %}
          {% if mode == 'Off' %} 99
          {% elif mode == 'Eco' %} {{ base + 1 }}                 {# zpÅ™Ã­snit #}
          {% elif mode == 'Boost' %} {{ [base - 1, 0] | max }}    {# povolit #}
          {% else %} {{ base }}                                   {# Auto #}
          {% endif %}

      # â†’ efektivnÃ­ zpoÅ¾dÄ›nÃ­ zapnutÃ­/vypnutÃ­ (mÅ¯Å¾eÅ¡ mÄ›nit dle chuti pro reÅ¾imy)
      - name: "kotel_effective_on_delay_sec"
        unit_of_measurement: s
        state: >
          {% set base = states('input_number.kotel_on_delay_sec')|int(120) %}
          {% set mode = states('input_select.topny_rezim') %}
          {% if mode == 'Boost' %} {{ [base - 60, 0] | max }}     {# v Boost kratÅ¡Ã­ #}
          {% else %} {{ base }}
          {% endif %}

      - name: "kotel_effective_off_delay_sec"
        unit_of_measurement: s
        state: >
          {% set base = states('input_number.kotel_off_delay_sec')|int(300) %}
          {% set mode = states('input_select.topny_rezim') %}
          {% if mode == 'Eco' %} {{ base + 60 }}                  {# v Eco delÅ¡Ã­ setrvaÄnost #}
          {% else %} {{ base }}
          {% endif %}

  - binary_sensor:
      # â†’ je splnÄ›n prah â€žpoÄet aktivnÃ­ch zÃ³nâ€œ ?
      - name: "kotel_threshold_ok_active_zones"
        state: >
          {{ (states('sensor.kotel_aktivni_zony_pocet')|int(0)) >=
             (states('sensor.kotel_effective_min_active_zones')|int(99)) }}

      # â†’ je splnÄ›n prah â€žprÅ¯mÄ›rnÃ¡ poptÃ¡vkaâ€œ ?
      - name: "kotel_threshold_ok_avg_demand"
        state: >
          {{ (states('sensor.kotel_poptavka_prumer')|float(0)) >=
             (states('sensor.kotel_effective_min_avg_demand_pct')|float(999)) }}

      # â†’ celkovÄ› splnÄ›no pro zapnutÃ­? (ANY â€“ poÄet ZÃ“N nebo AVG poptÃ¡vka)
      - name: "kotel_threshold_any_ok"
        state: >
          {{ is_state('binary_sensor.kotel_threshold_ok_active_zones','on')
             or is_state('binary_sensor.kotel_threshold_ok_avg_demand','on') }}

      # â†’ reÅ¾im OFF nÃ¡silnÄ› blokuje chod
      - name: "kotel_mode_off_block"
        state: >
          {{ is_state('input_select.topny_rezim','Off') }}
